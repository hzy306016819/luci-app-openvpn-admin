name: Build luci-app-openvpn-admin

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180  # 3小时超时
    
    strategy:
      matrix:
        # 仅保留 360T7 和 x86_64 架构
        target: ["x86_64", "aarch64_cortex-a72"]
        include:
          - target: x86_64
            sdk_name: x86-64
            # ImmortalWrt 23.05.0 SDK 路径
            sdk_subpath: targets/x86/64/immortalwrt-sdk-23.05.0-x86-64_gcc-12.3.0_musl.Linux-x86_64.tar.xz
          - target: aarch64_cortex-a72
            sdk_name: rockchip-armv8
            # 360T7 属于 rockchip-armv8 架构
            sdk_subpath: targets/rockchip/armv8/immortalwrt-sdk-23.05.0-rockchip-armv8_gcc-12.3.0_musl.Linux-x86_64.tar.xz
    
    steps:
    - name: 1检出代码
      uses: actions/checkout@v4
    
    - name: 2安装必要工具
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          libncurses5-dev \
          gawk \
          git \
          wget \
          unzip \
          python3 \
          python3-pip \
          file \
          rsync \
          curl
    
    - name: 3下载ImmortalWrt SDK（带重试）
      id: download_sdk
      run: |
        echo "下载 ${{ matrix.target }} 架构的SDK..."
        
        # 稳定的 ImmortalWrt 镜像源
        MIRRORS=(
          "https://downloads.immortalwrt.org/releases/23.05.0"
          "https://mirrors.pku.edu.cn/immortalwrt/releases/23.05.0"
        )
        
        # 尝试从不同镜像下载
        for MIRROR in "${MIRRORS[@]}"; do
          SDK_URL="${MIRROR}/${{ matrix.sdk_subpath }}"
          echo "尝试从: $SDK_URL"
          if wget --timeout=30 --tries=3 "$SDK_URL" -O openwrt-sdk.tar.xz; then
            echo "✅ 下载成功"
            break
          else
            echo "❌ 下载失败，尝试下一个镜像..."
            rm -f openwrt-sdk.tar.xz
          fi
        done
        
        # 检查是否下载成功
        if [ ! -f "openwrt-sdk.tar.xz" ]; then
          echo "❌ 所有镜像都下载失败"
          exit 1
        fi
        
        echo "解压SDK..."
        tar -xf openwrt-sdk.tar.xz
        mv immortalwrt-sdk-* openwrt-sdk
    
    - name: 4准备包文件
      run: |
        echo "准备包文件..."
        cd openwrt-sdk
        
        # 创建包目录
        mkdir -p package/luci-app-openvpn-admin
        
        # 复制插件文件
        if [ -d "../package/luci-app-openvpn-admin" ]; then
          cp -r ../package/luci-app-openvpn-admin/* package/luci-app-openvpn-admin/
        fi
        
        if [ -d "../files" ]; then
          cp -r ../files/* package/luci-app-openvpn-admin/
        fi
        
        # 检查文件结构
        echo "检查文件结构:"
        find package/luci-app-openvpn-admin -type f | head -20
    
    - name: 5配置和构建
      run: |
        cd openwrt-sdk
        echo "配置构建环境..."
        
        # 生成配置文件
        cat > .config << EOF
        CONFIG_TARGET_${{ matrix.sdk_name }}=y
        CONFIG_PACKAGE_luci-app-openvpn-admin=y
        EOF
        
        # 更新feeds并解决依赖
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
        echo "开始构建插件..."
        make package/luci-app-openvpn-admin/compile V=s 2>&1 | tail -50
    
    - name: 6查找IPK文件
      run: |
        cd openwrt-sdk
        echo "查找生成的IPK文件..."
        
        IPK_FILE=$(find bin/packages -name "luci-app-openvpn-admin*.ipk" -type f | head -1)
        if [ -n "$IPK_FILE" ]; then
          echo "找到: $IPK_FILE"
          cp "$IPK_FILE" ../luci-app-openvpn-admin-${{ matrix.target }}.ipk
        else
          echo "❌ 未找到IPK文件"
          find . -name "*.ipk" -type f | head -20
          exit 1
        fi
        
        ls -lh ../luci-app-openvpn-admin-${{ matrix.target }}.ipk
    
    - name: 7上传产物
      uses: actions/upload-artifact@v4
      with:
        name: openvpn-admin-${{ matrix.target }}
        path: luci-app-openvpn-admin-${{ matrix.target }}.ipk
        retention-days: 7
    
    - name: 8构建状态
      if: always()
      run: |
        echo "========================================"
        echo "构建状态报告 - ${{ matrix.target }}"
        echo "========================================"
        echo "作业状态: ${{ job.status }}"
        echo "步骤状态: ${{ steps.download_sdk.outcome }}"
        echo ""
        
        if [ -f "luci-app-openvpn-admin-${{ matrix.target }}.ipk" ]; then
          echo "✅ 构建成功!"
        else
          echo "❌ 构建失败或文件未生成"
        fi
