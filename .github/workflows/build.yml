name: Build luci-app-openvpn-admin

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180  # 3小时超时
    
    strategy:
      matrix:
        target: ["x86_64", "mipsel_24kc", "aarch64_generic", "aarch64_cortex-a72", "arm_cortex-a7_neon-vfpv4"]
        include:
          - target: x86_64
            sdk_name: x86-64
          - target: mipsel_24kc
            sdk_name: ramips-mt7621
          - target: aarch64_generic
            sdk_name: armvirt-64
          - target: aarch64_cortex-a72
            sdk_name: rockchip-armv8
          - target: arm_cortex-a7_neon-vfpv4
            sdk_name: sunxi-cortexa7
    
    steps:
    - name: 1检出代码
      uses: actions/checkout@v4
    
    - name: 2安装必要工具
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          libncurses5-dev \
          gawk \
          git \
          wget \
          unzip \
          python3 \
          python3-pip \
          file
    
    - name: 3下载SDK（带重试）
      id: download_sdk
      continue-on-error: true
      run: |
        echo "下载 ${{ matrix.target }} 架构的SDK..."
        
        # 使用不同的镜像源
        MIRRORS=(
          "https://downloads.openwrt.org/releases/22.03.5"
          "https://mirror2.openwrt.org/releases/22.03.5"
          "https://mirrors.cloud.tencent.com/openwrt/releases/22.03.5"
        )
        
        # 根据目标选择SDK
        case "${{ matrix.target }}" in
          x86_64)
            SDK_PATH="targets/x86/64/openwrt-sdk-22.03.5-x86-64_gcc-11.2.0_musl.Linux-x86_64.tar.xz"
            ;;
          mipsel_24kc)
            SDK_PATH="targets/ramips/mt7621/openwrt-sdk-22.03.5-ramips-mt7621_gcc-11.2.0_musl.Linux-x86_64.tar.xz"
            ;;
          aarch64_generic)
            SDK_PATH="targets/armvirt/64/openwrt-sdk-22.03.5-armvirt-64_gcc-11.2.0_musl.Linux-x86_64.tar.xz"
            ;;
          aarch64_cortex-a72)
            SDK_PATH="targets/rockchip/armv8/openwrt-sdk-22.03.5-rockchip-armv8_gcc-11.2.0_musl.Linux-x86_64.tar.xz"
            ;;
          arm_cortex-a7_neon-vfpv4)
            SDK_PATH="targets/sunxi/cortexa7/openwrt-sdk-22.03.5-sunxi-cortexa7_gcc-11.2.0_musl.Linux-x86_64.tar.xz"
            ;;
        esac
        
        # 尝试从不同镜像下载
        for MIRROR in "${MIRRORS[@]}"; do
          SDK_URL="${MIRROR}/${SDK_PATH}"
          echo "尝试从: $SDK_URL"
          if wget --timeout=30 --tries=3 "$SDK_URL" -O openwrt-sdk.tar.xz; then
            echo "✅ 下载成功"
            break
          else
            echo "❌ 下载失败，尝试下一个镜像..."
            rm -f openwrt-sdk.tar.xz
          fi
        done
        
        # 检查是否下载成功
        if [ ! -f "openwrt-sdk.tar.xz" ]; then
          echo "❌ 所有镜像都下载失败"
          exit 1
        fi
        
        echo "解压SDK..."
        tar -xf openwrt-sdk.tar.xz
        mv openwrt-sdk-* openwrt-sdk
    
    - name: 4准备包文件
      run: |
        echo "准备包文件..."
        cd openwrt-sdk
        
        # 创建包目录
        mkdir -p package/luci-app-openvpn-admin
        
        # 复制现有文件
        if [ -d "../package/luci-app-openvpn-admin" ]; then
          cp -r ../package/luci-app-openvpn-admin/* package/luci-app-openvpn-admin/
        fi
        
        if [ -d "../files" ]; then
          cp -r ../files/* package/luci-app-openvpn-admin/
        fi
        
        # 检查文件
        echo "检查文件结构:"
        find package/luci-app-openvpn-admin -type f | head -20
    
    - name: 5配置和构建
      run: |
        cd openwrt-sdk
        echo "配置构建环境..."
        
        # 创建默认配置
        cat > .config << EOF
        CONFIG_TARGET_${{ matrix.sdk_name }}=y
        CONFIG_PACKAGE_luci-app-openvpn-admin=y
        EOF
        
        echo "开始构建..."
        # 只编译指定的包
        make package/luci-app-openvpn-admin/compile V=s 2>&1 | tail -50
    
    - name: 6查找IPK文件
      run: |
        cd openwrt-sdk
        echo "查找生成的IPK文件..."
        
        # 在不同位置查找
        for dir in bin packages bin/packages; do
          if [ -d "$dir" ]; then
            IPK_FILE=$(find "$dir" -name "luci-app-openvpn-admin*.ipk" -type f | head -1)
            if [ -n "$IPK_FILE" ]; then
              echo "找到: $IPK_FILE"
              cp "$IPK_FILE" ../luci-app-openvpn-admin-${{ matrix.target }}.ipk
              break
            fi
          fi
        done
        
        # 检查是否找到文件
        if [ -f "../luci-app-openvpn-admin-${{ matrix.target }}.ipk" ]; then
          echo "✅ IPK文件复制成功"
          ls -lh ../luci-app-openvpn-admin-${{ matrix.target }}.ipk
        else
          echo "❌ 未找到IPK文件"
          # 列出所有IPK文件帮助调试
          find . -name "*.ipk" -type f | head -20
        fi
    
    - name: 7上传产物
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: openvpn-admin-${{ matrix.target }}
        path: luci-app-openvpn-admin-${{ matrix.target }}.ipk
        retention-days: 7
    
    - name: 8构建状态
      if: always()
      run: |
        echo "========================================"
        echo "构建状态报告 - ${{ matrix.target }}"
        echo "========================================"
        echo "作业状态: ${{ job.status }}"
        echo "步骤状态: ${{ steps.download_sdk.outcome }}"
        echo ""
        
        if [ -f "luci-app-openvpn-admin-${{ matrix.target }}.ipk" ]; then
          echo "✅ 构建成功!"
          echo "文件: luci-app-openvpn-admin-${{ matrix.target }}.ipk"
        else
          echo "❌ 构建失败或文件未生成"
        fi
