name: Build luci-app-openvpn-admin

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      target_arch:
        description: 'Target architectures (comma separated)'
        required: false
        default: 'x86_64,aarch64_cortex-a53'
      build_type:
        description: 'Build type'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - x86_only
          - mt7981_only

jobs:
  build:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        # 如果有输入参数，使用输入参数，否则使用默认值
        target: ${{ fromJSON(github.event.inputs.target_arch && '["' + github.event.inputs.target_arch + '"]' || '["x86_64", "aarch64_cortex-a53"]') }}
        include:
          - target: x86_64
            device: x86/64
            sdk_name: x86-64
            sdk_url: https://downloads.openwrt.org/snapshots/targets/x86/64/openwrt-sdk-x86-64_gcc-12.3.0_musl.Linux-x86_64.tar.xz
          - target: aarch64_cortex-a53
            device: mediatek/mt7981  # 360T7
            sdk_name: mediatek-mt7981
            sdk_url: https://downloads.openwrt.org/snapshots/targets/mediatek/mt7981/openwrt-sdk-mediatek-mt7981_gcc-12.3.0_musl.Linux-x86_64.tar.xz
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup Build Environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          libncurses5-dev \
          libncursesw5-dev \
          zlib1g-dev \
          gawk \
          git \
          gettext \
          libssl-dev \
          xsltproc \
          rsync \
          wget \
          unzip \
          python3 \
          python3-setuptools
        echo "Build environment setup completed"
    
    - name: Download OpenWrt SDK for ${{ matrix.target }}
      run: |
        echo "Downloading SDK for ${{ matrix.target }}"
        
        # 根据目标架构选择 SDK URL
        case "${{ matrix.target }}" in
          x86_64)
            SDK_URL="https://downloads.openwrt.org/snapshots/targets/x86/64/openwrt-sdk-x86-64_gcc-12.3.0_musl.Linux-x86_64.tar.xz"
            ;;
          aarch64_cortex-a53)
            SDK_URL="https://downloads.openwrt.org/snapshots/targets/mediatek/mt7981/openwrt-sdk-mediatek-mt7981_gcc-12.3.0_musl.Linux-x86_64.tar.xz"
            ;;
          *)
            echo "Unsupported target: ${{ matrix.target }}"
            exit 1
            ;;
        esac
        
        echo "Downloading SDK from: $SDK_URL"
        wget -q "$SDK_URL" -O openvpn-sdk.tar.xz
        tar -xf openvpn-sdk.tar.xz
        mv openwrt-sdk-* openwrt-sdk
        echo "SDK downloaded and extracted"
    
    - name: Prepare Build Files
      run: |
        echo "准备构建文件..."
        cd openwrt-sdk
        mkdir -p package/luci-app-openvpn-admin
        
        # 复制文件到 SDK
        cp -r ../files package/luci-app-openvpn-admin/
        
        # 创建 package Makefile
        cat > package/luci-app-openvpn-admin/Makefile << 'EOF'
include $(TOPDIR)/rules.mk

PKG_NAME:=luci-app-openvpn-admin
PKG_VERSION:=1.0.0
PKG_RELEASE:=$(shell date +%Y%m%d)

PKG_BUILD_DIR:=$(BUILD_DIR)/$(PKG_NAME)-$(PKG_VERSION)

include $(INCLUDE_DIR)/package.mk

define Package/$(PKG_NAME)
  SECTION:=luci
  CATEGORY:=LuCI
  SUBMENU:=3. Applications
  TITLE:=OpenVPN Management Interface
  PKGARCH:=all
  DEPENDS:=+luci-base +openvpn-openssl +luci-lib-jsonc +easy-rsa +curl +openssl-util +netcat-openbsd
endef

define Package/$(PKG_NAME)/description
  A comprehensive OpenVPN management interface for OpenWrt/LEDE/ImmortalWrt.
  Features include client management, certificate generation, connection monitoring,
  and server configuration.
endef

define Build/Prepare
	mkdir -p $(PKG_BUILD_DIR)
endef

define Build/Configure
endef

define Build/Compile
endef

define Package/$(PKG_NAME)/install
	$(INSTALL_DIR) $(1)/usr/lib/lua/luci/controller
	$(INSTALL_DATA) ./files/usr/lib/lua/luci/controller/openvpn-admin.lua \
		$(1)/usr/lib/lua/luci/controller/
	
	$(INSTALL_DIR) $(1)/usr/lib/lua/luci/view/openvpn-admin
	$(INSTALL_DATA) ./files/usr/lib/lua/luci/view/openvpn-admin/*.htm \
		$(1)/usr/lib/lua/luci/view/openvpn-admin/
	
	$(INSTALL_DIR) $(1)/etc/config
	$(INSTALL_DATA) ./files/etc/config/openvpn-admin \
		$(1)/etc/config/
	
	$(INSTALL_DIR) $(1)/etc/openvpn-admin
	$(INSTALL_BIN) ./files/etc/openvpn-admin/generate-client.sh \
		$(1)/etc/openvpn-admin/
	$(INSTALL_BIN) ./files/etc/openvpn-admin/client-connect-cn.sh \
		$(1)/etc/openvpn-admin/
	$(INSTALL_BIN) ./files/etc/openvpn-admin/clean-garbage.sh \
		$(1)/etc/openvpn-admin/
	$(INSTALL_DATA) ./files/etc/openvpn-admin/renewcert.sh \
		$(1)/etc/openvpn-admin/
	
	$(INSTALL_DIR) $(1)/etc/openvpn-admin/template
	$(INSTALL_DATA) ./files/etc/openvpn-admin/template/server.template \
		$(1)/etc/openvpn-admin/template/
	
	$(INSTALL_DIR) $(1)/tmp/openvpn-admin
	$(INSTALL_DIR) $(1)/etc/openvpn/pki
endef

define Package/$(PKG_NAME)/postinst
#!/bin/sh
if [ -z "$${IPKG_INSTROOT}" ]; then
	mkdir -p /etc/openvpn-admin/template 2>/dev/null
	mkdir -p /tmp/openvpn-admin 2>/dev/null
	mkdir -p /etc/openvpn/pki 2>/dev/null
	chmod 755 /etc/openvpn-admin/*.sh 2>/dev/null || true
	/etc/init.d/uhttpd restart >/dev/null 2>&1 || true
fi
exit 0
endef

$(eval $(call BuildPackage,$(PKG_NAME)))
EOF
        
        echo "构建文件准备完成"
    
    - name: Build Package
      run: |
        cd openwrt-sdk
        echo "开始构建包..."
        
        # 更新 feeds
        ./scripts/feeds update -a
        
        # 编译包
        make package/luci-app-openvpn-admin/compile V=s
        
        # 复制生成的 IPK 文件
        find bin -name "luci-app-openvpn-admin*.ipk" -type f | while read ipk; do
          echo "找到 IPK 文件: $ipk"
          cp "$ipk" ../luci-app-openvpn-admin-${{ matrix.target }}.ipk
        done
        
        # 如果没有找到，可能是路径不同
        if [ ! -f ../luci-app-openvpn-admin-${{ matrix.target }}.ipk ]; then
          echo "尝试在其他目录查找..."
          find . -name "*.ipk" -type f | grep -i "openvpn" | head -5
        fi
    
    - name: Upload Artifact
      uses: actions/upload-artifact@v3
      with:
        name: luci-app-openvpn-admin-${{ matrix.target }}
        path: |
          luci-app-openvpn-admin-${{ matrix.target }}.ipk
        retention-days: 7
    
    - name: Create Release (on tag only)
      if: github.event_name == 'release'
      uses: softprops/action-gh-release@v1
      with:
        files: |
          luci-app-openvpn-admin-${{ matrix.target }}.ipk
        draft: false
        prerelease: false
