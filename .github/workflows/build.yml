name: Build luci-app-openvpn-admin

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        target: ["x86_64", "mipsel_24kc", "aarch64_cortex-a53", "aarch64_cortex-a72", "arm_cortex-a7_neon-vfpv4"]
        include:
          - target: x86_64
            sdk_name: x86-64
          - target: mipsel_24kc
            sdk_name: ramips-mt7621
          - target: aarch64_cortex-a53
            sdk_name: mediatek-mt7981
          - target: aarch64_cortex-a72
            sdk_name: rockchip-armv8
          - target: arm_cortex-a7_neon-vfpv4
            sdk_name: sunxi-cortexa7
    
    steps:
    - name: 1æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        show-progress: true
      timeout-minutes: 5
    
    - name: 2æ˜¾ç¤ºä»“åº“ç»“æ„
      run: |
        echo "ğŸ“ å½“å‰ä»“åº“ç»“æ„ï¼š"
        echo "========================================"
        find . -maxdepth 3 -type f -name "*.mk" -o -name "*.lua" -o -name "*.htm" -o -name "*.sh" | sort
        echo "========================================"
        echo ""
        echo "ğŸ“¦ æ£€æŸ¥åŒ…ç›®å½•ï¼š"
        if [ -d "package/luci-app-openvpn-admin" ]; then
          echo "âœ… æ‰¾åˆ° package/luci-app-openvpn-admin ç›®å½•"
          ls -la package/luci-app-openvpn-admin/
          echo ""
          if [ -f "package/luci-app-openvpn-admin/Makefile" ]; then
            echo "âœ… æ‰¾åˆ° Makefile æ–‡ä»¶"
            head -20 package/luci-app-openvpn-admin/Makefile
          else
            echo "âŒ æœªæ‰¾åˆ° Makefile æ–‡ä»¶"
          fi
        else
          echo "âŒ æœªæ‰¾åˆ° package/luci-app-openvpn-admin ç›®å½•"
        fi
    
    - name: 3è®¾ç½®æ„å»ºç¯å¢ƒ
      run: |
        echo "ğŸ› ï¸ å®‰è£…æ„å»ºä¾èµ–åŒ…..."
        sudo apt-get update
        echo "å®‰è£…çš„è½¯ä»¶åŒ…ï¼š"
        sudo apt-get install -y \
          build-essential \
          libncurses5-dev \
          libncursesw5-dev \
          zlib1g-dev \
          gawk \
          git \
          gettext \
          libssl-dev \
          xsltproc \
          rsync \
          wget \
          unzip \
          python3 \
          python3-setuptools 2>&1 | grep -E "Installing|Setting up|is already"
        echo "âœ… æ„å»ºç¯å¢ƒè®¾ç½®å®Œæˆ"
    
    - name: 4ç¡®å®šSDKä¸‹è½½åœ°å€
      id: sdk_info
      run: |
        echo "ğŸ” ç¡®å®š ${{ matrix.target }} æ¶æ„çš„SDKåœ°å€..."
        
        # å°è¯•è·å–æœ€æ–°çš„SDKé“¾æ¥
        case "${{ matrix.target }}" in
          x86_64)
            # å°è¯•è·å–æœ€æ–°ç‰ˆæœ¬çš„x86_64 SDK
            echo "å°è¯•è·å–æœ€æ–°x86_64 SDKé“¾æ¥..."
            SDK_URL="https://downloads.openwrt.org/releases/23.05.3/targets/x86/64/openwrt-sdk-23.05.3-x86-64_gcc-12.3.0_musl.Linux-x86_64.tar.xz"
            echo "ğŸ“¦ æ¶æ„: x86_64"
            echo "ğŸ”— SDK: $SDK_URL"
            ;;
          mipsel_24kc)
            # ä½¿ç”¨22.03.5ç‰ˆæœ¬çš„mipsel SDK
            SDK_URL="https://downloads.openwrt.org/releases/22.03.5/targets/ramips/mt7621/openwrt-sdk-22.03.5-ramips-mt7621_gcc-11.2.0_musl.Linux-x86_64.tar.xz"
            echo "ğŸ“¦ æ¶æ„: mipsel_24kc"
            echo "ğŸ”— SDK: $SDK_URL"
            ;;
          aarch64_cortex-a53)
            # ä½¿ç”¨23.05.0ç‰ˆæœ¬çš„aarch64 SDK
            SDK_URL="https://downloads.openwrt.org/releases/23.05.0/targets/mediatek/filogic/openwrt-sdk-23.05.0-mediatek-filogic_gcc-12.3.0_musl.Linux-x86_64.tar.xz"
            echo "ğŸ“¦ æ¶æ„: aarch64_cortex-a53"
            echo "ğŸ”— SDK: $SDK_URL"
            ;;
          aarch64_cortex-a72)
            # ä½¿ç”¨23.05.0ç‰ˆæœ¬çš„rockchip SDK
            SDK_URL="https://downloads.openwrt.org/releases/23.05.0/targets/rockchip/armv8/openwrt-sdk-23.05.0-rockchip-armv8_gcc-12.3.0_musl.Linux-x86_64.tar.xz"
            echo "ğŸ“¦ æ¶æ„: aarch64_cortex-a72"
            echo "ğŸ”— SDK: $SDK_URL"
            ;;
          arm_cortex-a7_neon-vfpv4)
            # ä½¿ç”¨22.03.5ç‰ˆæœ¬çš„sunxi SDK
            SDK_URL="https://downloads.openwrt.org/releases/22.03.5/targets/sunxi/cortexa7/openwrt-sdk-22.03.5-sunxi-cortexa7_gcc-11.2.0_musl.Linux-x86_64.tar.xz"
            echo "ğŸ“¦ æ¶æ„: arm_cortex-a7_neon-vfpv4"
            echo "ğŸ”— SDK: $SDK_URL"
            ;;
        esac
        
        echo "SDK_URL=$SDK_URL" >> $GITHUB_ENV
        echo "âœ… SDKåœ°å€ç¡®å®šå®Œæˆ"
        
        # æµ‹è¯•é“¾æ¥æ˜¯å¦æœ‰æ•ˆ
        echo "æµ‹è¯•é“¾æ¥æœ‰æ•ˆæ€§..."
        if wget --spider "$SDK_URL" 2>/dev/null; then
          echo "âœ… é“¾æ¥æœ‰æ•ˆ"
        else
          echo "âš ï¸  é“¾æ¥å¯èƒ½æ— æ•ˆï¼Œä½†ç»§ç»­å°è¯•ä¸‹è½½..."
        fi
    
    - name: 5ä¸‹è½½OpenWrt SDK
      timeout-minutes: 10
      run: |
        echo "â¬‡ï¸ ä¸‹è½½ ${{ matrix.target }} æ¶æ„çš„ SDK..."
        echo "ä¸‹è½½åœ°å€: ${{ env.SDK_URL }}"
        
        # å°è¯•ä¸‹è½½ï¼Œå¦‚æœå¤±è´¥åˆ™ä½¿ç”¨å¤‡ç”¨é“¾æ¥
        echo "å°è¯•ä¸‹è½½ä¸»é“¾æ¥..."
        if ! wget --progress=dot:giga "${{ env.SDK_URL }}" -O openwrt-sdk.tar.xz; then
          echo "ä¸»é“¾æ¥ä¸‹è½½å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨é“¾æ¥..."
          
          # æ ¹æ®æ¶æ„é€‰æ‹©å¤‡ç”¨é“¾æ¥
          case "${{ matrix.target }}" in
            x86_64)
              # å¤‡ç”¨é“¾æ¥ï¼šä½¿ç”¨22.03.5ç‰ˆæœ¬
              BACKUP_URL="https://downloads.openwrt.org/releases/22.03.5/targets/x86/64/openwrt-sdk-22.03.5-x86-64_gcc-11.2.0_musl.Linux-x86_64.tar.xz"
              ;;
            mipsel_24kc)
              # å¤‡ç”¨é“¾æ¥ï¼šä½¿ç”¨21.02.7ç‰ˆæœ¬
              BACKUP_URL="https://downloads.openwrt.org/releases/21.02.7/targets/ramips/mt7621/openwrt-sdk-21.02.7-ramips-mt7621_gcc-8.4.0_musl.Linux-x86_64.tar.xz"
              ;;
            aarch64_cortex-a53)
              # å¤‡ç”¨é“¾æ¥ï¼šä½¿ç”¨22.03.5ç‰ˆæœ¬
              BACKUP_URL="https://downloads.openwrt.org/releases/22.03.5/targets/armvirt/64/openwrt-sdk-22.03.5-armvirt-64_gcc-11.2.0_musl.Linux-x86_64.tar.xz"
              ;;
            aarch64_cortex-a72)
              # å¤‡ç”¨é“¾æ¥ï¼šä½¿ç”¨22.03.5ç‰ˆæœ¬
              BACKUP_URL="https://downloads.openwrt.org/releases/22.03.5/targets/rockchip/armv8/openwrt-sdk-22.03.5-rockchip-armv8_gcc-11.2.0_musl.Linux-x86_64.tar.xz"
              ;;
            arm_cortex-a7_neon-vfpv4)
              # å¤‡ç”¨é“¾æ¥ï¼šä½¿ç”¨21.02.7ç‰ˆæœ¬
              BACKUP_URL="https://downloads.openwrt.org/releases/21.02.7/targets/sunxi/cortexa7/openwrt-sdk-21.02.7-sunxi-cortexa7_gcc-8.4.0_musl.Linux-x86_64.tar.xz"
              ;;
          esac
          
          echo "å°è¯•å¤‡ç”¨é“¾æ¥: $BACKUP_URL"
          wget --progress=dot:giga "$BACKUP_URL" -O openwrt-sdk.tar.xz
        fi
        
        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä¸‹è½½æˆåŠŸ
        if [ ! -f "openwrt-sdk.tar.xz" ]; then
          echo "âŒ SDK ä¸‹è½½å¤±è´¥"
          exit 1
        fi
        
        DOWNLOAD_SIZE=$(stat -c%s openwrt-sdk.tar.xz 2>/dev/null || wc -c < openwrt-sdk.tar.xz)
        echo "âœ… SDK ä¸‹è½½å®Œæˆï¼Œå¤§å°: $((DOWNLOAD_SIZE/1024/1024))MB"
        
        echo "ğŸ“¦ è§£å‹ SDK..."
        tar -xvf openwrt-sdk.tar.xz
        SDK_DIR=$(find . -maxdepth 1 -name "openwrt-sdk-*" -type d | head -1)
        
        if [ -z "$SDK_DIR" ]; then
          echo "âŒ æœªæ‰¾åˆ°è§£å‹åçš„SDKç›®å½•"
          exit 1
        fi
        
        mv "$SDK_DIR" openwrt-sdk
        echo "âœ… SDK è§£å‹å®Œæˆï¼Œç›®å½•: openwrt-sdk"
        
        echo "ğŸ“ SDK ç›®å½•ç»“æ„:"
        ls -la openwrt-sdk/
    
    - name: 6å‡†å¤‡åŒ…æ–‡ä»¶
      run: |
        echo "ğŸ“‹ å‡†å¤‡åŒ…æ–‡ä»¶..."
        echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
        echo ""
        
        # æ£€æŸ¥æºæ–‡ä»¶
        echo "ğŸ“ æºæ–‡ä»¶æ£€æŸ¥:"
        if [ -d "package/luci-app-openvpn-admin" ]; then
          echo "âœ… æ‰¾åˆ° package/luci-app-openvpn-admin"
          echo "   åŒ…å«æ–‡ä»¶:"
          ls -la package/luci-app-openvpn-admin/
        else
          echo "âŒ æœªæ‰¾åˆ° package/luci-app-openvpn-admin"
          exit 1
        fi
        
        if [ -d "files" ]; then
          echo "âœ… æ‰¾åˆ° files ç›®å½•"
          echo "   åŒ…å«æ–‡ä»¶:"
          find files -type f | head -10
        else
          echo "âš ï¸  æœªæ‰¾åˆ° files ç›®å½•"
        fi
        
        # å¤åˆ¶æ–‡ä»¶åˆ° SDK
        echo ""
        echo "ğŸ”„ å¤åˆ¶æ–‡ä»¶åˆ° SDK..."
        cd openwrt-sdk
        echo "å½“å‰ç›®å½•: $(pwd)"
        
        mkdir -p package/luci-app-openvpn-admin
        echo "ğŸ“‚ å¤åˆ¶åŒ…æ–‡ä»¶..."
        cp -rv ../package/luci-app-openvpn-admin/* package/luci-app-openvpn-admin/
        
        if [ -d "../files" ]; then
          echo "ğŸ“‚ å¤åˆ¶ files ç›®å½•..."
          cp -rv ../files/* package/luci-app-openvpn-admin/
        fi
        
        # éªŒè¯å¤åˆ¶ç»“æœ
        echo ""
        echo "âœ… æ–‡ä»¶å¤åˆ¶å®Œæˆï¼ŒéªŒè¯ç»“æœ:"
        echo "ğŸ“ åŒ…ç›®å½•ç»“æ„:"
        find package/luci-app-openvpn-admin -type f | sort
        
        echo ""
        echo "ğŸ“„ Makefile å†…å®¹é¢„è§ˆ:"
        head -30 package/luci-app-openvpn-admin/Makefile 2>/dev/null || echo "æœªæ‰¾åˆ° Makefile"
    
    - name: 7æ„å»ºåŒ…
      timeout-minutes: 30
      run: |
        echo "ğŸ”¨ å¼€å§‹æ„å»º ${{ matrix.target }} æ¶æ„çš„åŒ…..."
        echo "å½“å‰ç›®å½•: $(pwd)"
        cd openwrt-sdk
        
        echo ""
        echo "ğŸ”§ é…ç½®æ„å»ºç¯å¢ƒ..."
        make defconfig 2>&1 | tail -20
        
        echo ""
        echo "ğŸš€ ç¼–è¯‘ luci-app-openvpn-admin..."
        echo "========================================"
        make package/luci-app-openvpn-admin/compile V=s 2>&1 | tee build.log | grep -E "(CC|CXX|LD|INSTALL|Creating|Error|error|Warning|warning)" || true
        echo "========================================"
        
        # æ£€æŸ¥æ„å»ºç»“æœ
        BUILD_STATUS=$?
        echo ""
        echo "ğŸ“Š æ„å»ºçŠ¶æ€: $BUILD_STATUS"
        
        if [ $BUILD_STATUS -eq 0 ]; then
          echo "âœ… æ„å»ºæˆåŠŸ!"
        else
          echo "âŒ æ„å»ºå¤±è´¥!"
          echo "æœ€å10è¡Œé”™è¯¯ä¿¡æ¯:"
          tail -20 build.log || true
        fi
    
    - name: 8æŸ¥æ‰¾å¹¶å¤åˆ¶IPKæ–‡ä»¶
      run: |
        echo "ğŸ” æŸ¥æ‰¾ç”Ÿæˆçš„IPKæ–‡ä»¶..."
        cd openwrt-sdk
        
        # åœ¨å¤šä¸ªå¯èƒ½çš„ä½ç½®æŸ¥æ‰¾
        echo "æœç´¢ç›®å½•:"
        find . -name "*.ipk" -type f 2>/dev/null | grep -i openvpn | head -10
        
        IPK_FILES=$(find . -name "luci-app-openvpn-admin*.ipk" -type f)
        if [ -n "$IPK_FILES" ]; then
          echo "âœ… æ‰¾åˆ°IPKæ–‡ä»¶:"
          echo "$IPK_FILES"
          
          # å¤åˆ¶ç¬¬ä¸€ä¸ªæ‰¾åˆ°çš„æ–‡ä»¶
          FIRST_IPK=$(echo "$IPK_FILES" | head -1)
          echo "ğŸ“‹ å¤åˆ¶æ–‡ä»¶: $FIRST_IPK"
          cp "$FIRST_IPK" ../luci-app-openvpn-admin-${{ matrix.target }}.ipk
          
          echo "ğŸ“Š æ–‡ä»¶ä¿¡æ¯:"
          ls -lh ../luci-app-openvpn-admin-${{ matrix.target }}.ipk
        else
          echo "âŒ æœªæ‰¾åˆ°IPKæ–‡ä»¶"
          echo "å¯èƒ½çš„ä½ç½®:"
          find bin -name "*.ipk" -type f 2>/dev/null || true
          find packages -name "*.ipk" -type f 2>/dev/null || true
          exit 1
        fi
    
    - name: 9ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: luci-app-openvpn-admin-${{ matrix.target }}
        path: luci-app-openvpn-admin-${{ matrix.target }}.ipk
        retention-days: 30
        if-no-files-found: error
    
    - name: ğŸ”Ÿ æ˜¾ç¤ºæ„å»ºæ‘˜è¦
      if: always()
      run: |
        echo ""
        echo "========================================"
        echo "ğŸ æ„å»ºå®Œæˆ - ${{ matrix.target }}"
        echo "========================================"
        echo ""
        echo "ğŸ“‹ æ„å»ºä¿¡æ¯:"
        echo "   æ¶æ„: ${{ matrix.target }}"
        echo "   è¿è¡ŒID: ${{ github.run_id }}"
        echo "   è¿è¡Œå·: ${{ github.run_number }}"
        echo ""
        echo "ğŸ“¥ ä¸‹è½½æ–¹å¼:"
        echo "   1. åœ¨å³ä¾§ Artifacts ä¸­ä¸‹è½½"
        echo "   2. æ–‡ä»¶å: luci-app-openvpn-admin-${{ matrix.target }}.ipk"
        echo ""
        echo "ğŸ”— æ°¸ä¹…é“¾æ¥:"
        echo "   https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        echo ""
        echo "ğŸ¤– å®‰è£…å‘½ä»¤:"
        echo "   scp luci-app-openvpn-admin-${{ matrix.target }}.ipk root@192.168.1.1:/tmp/"
        echo "   opkg install /tmp/luci-app-openvpn-admin-${{ matrix.target }}.ipk"
        echo "========================================"
