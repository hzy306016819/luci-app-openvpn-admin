name: Build luci-app-openvpn-admin

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        target: ["x86_64", "mipsel_24kc", "aarch64_cortex-a53", "aarch64_cortex-a72", "arm_cortex-a7_neon-vfpv4"]
        include:
          - target: x86_64
            sdk_name: x86-64
          - target: mipsel_24kc
            sdk_name: ramips-mt7621
          - target: aarch64_cortex-a53
            sdk_name: mediatek-mt7981
          - target: aarch64_cortex-a72
            sdk_name: rockchip-armv8
          - target: arm_cortex-a7_neon-vfpv4
            sdk_name: sunxi-cortexa7
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup Build Environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          libncurses5-dev \
          libncursesw5-dev \
          zlib1g-dev \
          gawk \
          git \
          gettext \
          libssl-dev \
          xsltproc \
          rsync \
          wget \
          unzip \
          python3 \
          python3-setuptools
    
    - name: Determine SDK URL
      run: |
        case "${{ matrix.target }}" in
          x86_64)
            echo "SDK_URL=https://downloads.openwrt.org/snapshots/targets/x86/64/openwrt-sdk-x86-64_gcc-12.3.0_musl.Linux-x86_64.tar.xz" >> $GITHUB_ENV
            ;;
          mipsel_24kc)
            echo "SDK_URL=https://downloads.openwrt.org/snapshots/targets/ramips/mt7621/openwrt-sdk-ramips-mt7621_gcc-12.3.0_musl.Linux-x86_64.tar.xz" >> $GITHUB_ENV
            ;;
          aarch64_cortex-a53)
            echo "SDK_URL=https://downloads.openwrt.org/snapshots/targets/mediatek/mt7981/openwrt-sdk-mediatek-mt7981_gcc-12.3.0_musl.Linux-x86_64.tar.xz" >> $GITHUB_ENV
            ;;
          aarch64_cortex-a72)
            echo "SDK_URL=https://downloads.openwrt.org/snapshots/targets/rockchip/armv8/openwrt-sdk-rockchip-armv8_gcc-12.3.0_musl.Linux-x86_64.tar.xz" >> $GITHUB_ENV
            ;;
          arm_cortex-a7_neon-vfpv4)
            echo "SDK_URL=https://downloads.openwrt.org/snapshots/targets/sunxi/cortexa7/openwrt-sdk-sunxi-cortexa7_gcc-12.3.0_musl.Linux-x86_64.tar.xz" >> $GITHUB_ENV
            ;;
        esac
    
    - name: Download OpenWrt SDK
      run: |
        wget -q "${{ env.SDK_URL }}" -O openwrt-sdk.tar.xz
        tar -xf openwrt-sdk.tar.xz
        mv openwrt-sdk-* openwrt-sdk
    
    - name: Prepare package files
      run: |
        echo "å¤åˆ¶åŒ…æ–‡ä»¶åˆ° SDK ä¸­..."
        cd openwrt-sdk
        
        # åˆ›å»ºåŒ…ç›®å½•
        mkdir -p package/luci-app-openvpn-admin
        
        # å¤åˆ¶æ•´ä¸ªåŒ…ç›®å½•ï¼ˆåŒ…æ‹¬ Makefile å’Œå…¶ä»–æ–‡ä»¶ï¼‰
        cp -r ../package/luci-app-openvpn-admin/* package/luci-app-openvpn-admin/
        
        # å¤åˆ¶ files ç›®å½•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if [ -d "../files" ]; then
          cp -r ../files/* package/luci-app-openvpn-admin/
        fi
        
        echo "éªŒè¯æ–‡ä»¶ç»“æ„..."
        find package/luci-app-openvpn-admin -type f | head -20
    
    - name: Build Package
      run: |
        cd openwrt-sdk
        echo "å¼€å§‹æ„å»º ${{ matrix.target }} æ¶æ„..."
        
        # é…ç½®
        make defconfig
        
        # ç¼–è¯‘åŒ…
        make package/luci-app-openvpn-admin/compile V=sc
        
        # æŸ¥æ‰¾ç”Ÿæˆçš„ IPK æ–‡ä»¶
        echo "æŸ¥æ‰¾ç”Ÿæˆçš„ IPK æ–‡ä»¶..."
        find bin -name "luci-app-openvpn-admin*.ipk" -type f
        
        # å¤åˆ¶ IPK æ–‡ä»¶
        for ipk in $(find bin -name "luci-app-openvpn-admin*.ipk" -type f); do
          echo "å¤åˆ¶: $ipk"
          cp "$ipk" ../luci-app-openvpn-admin-${{ matrix.target }}.ipk
          break
        done
    
    - name: Upload Artifact
      uses: actions/upload-artifact@v3
      with:
        name: luci-app-openvpn-admin-${{ matrix.target }}
        path: luci-app-openvpn-admin-${{ matrix.target }}.ipk
        retention-days: 30
    
    - name: Show Download Instructions
      run: |
        echo "=============================================="
        echo "âœ¨ æ„å»ºå®Œæˆï¼ä¸‹è½½è¯´æ˜ âœ¨"
        echo "=============================================="
        echo ""
        echo "ğŸ“¥ ä¸‹è½½ç¼–è¯‘å¥½çš„ IPK æ–‡ä»¶ï¼š"
        echo ""
        echo "1. ğŸ“‚ GitHub Actions Artifacts"
        echo "   ç‚¹å‡»å½“å‰è¿è¡Œçš„å·¥ä½œæµé¡µé¢å³ä¾§çš„ 'Artifacts'"
        echo "   æ‰¾åˆ° 'luci-app-openvpn-admin-${{ matrix.target }}'"
        echo "   ç‚¹å‡»ä¸‹è½½æŒ‰é’®å³å¯ä¸‹è½½"
        echo ""
        echo "2. ğŸ¤– å®‰è£…åˆ° OpenWrt"
        echo "   scp luci-app-openvpn-admin-${{ matrix.target }}.ipk root@è·¯ç”±å™¨IP:/tmp/"
        echo "   ssh root@è·¯ç”±å™¨IP 'opkg install /tmp/luci-app-openvpn-admin-${{ matrix.target }}.ipk'"
        echo ""
        echo "ğŸ“¦ æœ¬æ¬¡æ„å»ºæ¶æ„: ${{ matrix.target }}"
        echo "=============================================="
