name: Build luci-app-openvpn-admin (360T7 only)
on: [workflow_dispatch]

jobs:
  build-360t7:
    runs-on: ubuntu-22.04
    timeout-minutes: 180
    env:
      MAKE_JOBS: 2
      SDK_URL: "https://downloads.immortalwrt.org/releases/23.05.0/targets/rockchip/armv8/immortalwrt-sdk-23.05.0-rockchip-armv8_gcc-12.3.0_musl.Linux-x86_64.tar.xz"
      DEPENDENCIES: "openssl-util curl easy-rsa netcat-openbsd openvpn-openssl luci-lib-jsonc luci-compat luci-base"

    steps:
      - name: 1. Checkout code
        uses: actions/checkout@v4

      - name: 2. Install build dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y build-essential libncurses5-dev gawk git wget unzip python3 python3-pip file rsync curl python3-pyelftools subversion time
          sudo pip3 install pyelftools || true

      - name: 3. Download & extract ImmortalWrt SDK
        id: sdk
        run: |
          wget --timeout=60 --tries=3 $SDK_URL -O sdk.tar.xz || { echo "SDK download failed"; exit 1; }
          tar xf sdk.tar.xz && mv $(find . -maxdepth 1 -type d -name "*sdk*" | head -1) openwrt-sdk
          ls -la openwrt-sdk/

      - name: 4. Prepare package files
        run: |
          cd openwrt-sdk
          rm -rf package/luci-app-openvpn-admin && mkdir -p $_
          [ -f ../Makefile ] && cp ../Makefile package/luci-app-openvpn-admin/
          [ -d ../files ] && [ "$(ls -A ../files)" ] && cp -r ../files/* package/luci-app-openvpn-admin/
          [ -d ../package/luci-app-openvpn-admin ] && cp -r ../package/luci-app-openvpn-admin/* package/luci-app-openvpn-admin/
          mkdir -p package/luci-app-openvpn-admin/{usr/lib/lua/luci/{controller,view/openvpn-admin},etc/{config,openvpn-admin/template}}
          find package/luci-app-openvpn-admin -type f | head -20

      - name: 5. Update feeds & install dependencies
        run: |
          cd openwrt-sdk
          ./scripts/feeds update -a
          ./scripts/feeds install luci-base luci-lib-jsonc luci-compat openvpn-openssl easy-rsa netcat-openbsd curl openssl-util

      - name: 6. Generate .config
        run: |
          cd openwrt-sdk
          cat > .config << EOF
          CONFIG_TARGET_rockchip=y
          CONFIG_TARGET_rockchip_armv8=y
          CONFIG_TARGET_DEVICE_packages=y
          CONFIG_PACKAGE_luci-app-openvpn-admin=y
          CONFIG_PACKAGE_luci-base=y
          CONFIG_PACKAGE_luci-lib-jsonc=y
          CONFIG_PACKAGE_luci-compat=y
          CONFIG_PACKAGE_openvpn-openssl=y
          CONFIG_OPENVPN_OPENSSL_ENABLE_MANAGEMENT=y
          CONFIG_OPENVPN_OPENSSL_ENABLE_LZO=y
          CONFIG_OPENVPN_OPENSSL_ENABLE_LZ4=y
          CONFIG_PACKAGE_easy-rsa=y
          CONFIG_PACKAGE_netcat-openbsd=y
          CONFIG_PACKAGE_curl=y
          CONFIG_PACKAGE_openssl-util=y
          CONFIG_ALL=n
          CONFIG_ALL_KMODS=n
          CONFIG_ALL_NONSHARED=n
          EOF
          make defconfig
          grep -E "CONFIG_TARGET|CONFIG_PACKAGE|CONFIG_OPENVPN" .config

      - name: 7. Compile dependencies (fail ignore)
        run: |
          cd openwrt-sdk
          for pkg in $DEPENDENCIES; do
            echo "==== Compiling $pkg ===="
            if [ -d "package/$pkg" ] || [ -d "feeds/packages/$pkg" ] || [ -d "feeds/luci/$pkg" ]; then
              make package/$pkg/compile V=sc -j$MAKE_JOBS || echo "⚠ $pkg compile failed, skip"
            else
              echo "⚠ $pkg not found, skip"
            fi
          done

      - name: 8. Compile main package
        run: |
          cd openwrt-sdk
          [ ! -d "package/luci-app-openvpn-admin" ] && { echo "Package dir missing"; exit 1; }
          make package/luci-app-openvpn-admin/clean
          time make package/luci-app-openvpn-admin/compile V=s -j$MAKE_JOBS
          find bin -name "*luci-app-openvpn-admin*" -type f

      - name: 9. Collect artifacts
        run: |
          cd openwrt-sdk
          mkdir -p ../output-360T7
          find bin -name "*.ipk" -exec cp {} ../output-360T7/ \;
          MAIN_IPK=$(find bin -name "*luci-app-openvpn-admin*.ipk" | head -1)
          if [ -n "$MAIN_IPK" ]; then
            echo "✅ Success: $(basename $MAIN_IPK)"
            tar -tzf $MAIN_IPK | grep -E "(controller|view|etc/config)" | head -10
          else
            echo "❌ Main package not found"
            find bin -name "*.ipk" | xargs -I {} basename {} | sort
          fi
          ls -lh ../output-360T7/

      - name: 10. Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: openvpn-admin-360T7
          path: output-360T7/
          retention-days: 7

      - name: 11. Build report
        if: always()
        run: |
          echo "==== Build Report for 360T7 ===="
          echo "Job status: ${{ job.status }}"
          echo "SDK status: ${{ steps.sdk.outcome }}"
          [ -d output-360T7 ] && ls -la output-360T7/ || echo "Output dir missing"
          IPK_COUNT=$(find output-360T7 -name "*.ipk" | wc -l)
          echo "Total IPKs: $IPK_COUNT"
          MAIN_IPK=$(find output-360T7 -name "*luci-app-openvpn-admin*.ipk" | head -1)
          [ -n "$MAIN_IPK" ] && echo "✅ Main package: $(basename $MAIN_IPK)" || echo "❌ Build failed"
