name: Build luci-app-openvpn-admin (360T7 only)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180

    steps:
    - name: 1æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: 2å®‰è£…å®Œæ•´ä¾èµ–å·¥å…·
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          libncurses5-dev \
          gawk \
          git \
          wget \
          unzip \
          python3 \
          python3-pip \
          file \
          rsync \
          curl \
          python3-pyelftools
        sudo pip3 install pyelftools || true

    - name: 3ä¸‹è½½ImmortalWrt SDKï¼ˆ360T7ä¸“å±žï¼‰
      id: download_sdk
      run: |
        echo "ä¸‹è½½ 360T7 (aarch64_cortex-a72) æž¶æž„çš„SDK..."
        MIRRORS=(
          "https://downloads.immortalwrt.org/releases/23.05.0"
          "https://mirrors.pku.edu.cn/immortalwrt/releases/23.05.0"
        )
        SDK_SUBPATH="targets/rockchip/armv8/immortalwrt-sdk-23.05.0-rockchip-armv8_gcc-12.3.0_musl.Linux-x86_64.tar.xz"
        
        for MIRROR in "${MIRRORS[@]}"; do
          SDK_URL="${MIRROR}/${SDK_SUBPATH}"
          echo "å°è¯•ä»Ž: $SDK_URL"
          if wget --timeout=30 --tries=3 "$SDK_URL" -O openwrt-sdk.tar.xz; then
            echo "âœ… ä¸‹è½½æˆåŠŸ"
            break
          else
            echo "âŒ ä¸‹è½½å¤±è´¥ï¼Œå°è¯•ä¸‹ä¸€ä¸ªé•œåƒ..."
            rm -f openwrt-sdk.tar.xz
          fi
        done
        
        if [ ! -f "openwrt-sdk.tar.xz" ]; then
          echo "âŒ æ‰€æœ‰é•œåƒéƒ½ä¸‹è½½å¤±è´¥"
          exit 1
        fi
        
        tar -xf openwrt-sdk.tar.xz
        mv immortalwrt-sdk-* openwrt-sdk

    - name: 4å‡†å¤‡åŒ…æ–‡ä»¶
      run: |
        cd openwrt-sdk
        mkdir -p package/luci-app-openvpn-admin
        if [ -d "../package/luci-app-openvpn-admin" ]; then
          cp -r ../package/luci-app-openvpn-admin/* package/luci-app-openvpn-admin/
        fi
        if [ -d "../files" ]; then
          cp -r ../files/* package/luci-app-openvpn-admin/
        fi
        echo "æ£€æŸ¥æ–‡ä»¶ç»“æž„:"
        find package/luci-app-openvpn-admin -type f | head -20

    - name: 5é…ç½®feedså¹¶å®‰è£…ä¾èµ–åŒ…
      run: |
        cd openwrt-sdk
        ./scripts/feeds update -a || true
        ./scripts/feeds install -a || true
        # å®‰è£…æ’ä»¶ä¾èµ–ï¼ˆå¤±è´¥å¿½ç•¥ï¼‰
        ./scripts/feeds install easy-rsa netcat-openbsd openvpn-openssl luci-lib-jsonc luci-compat curl openssl-util || true

    - name: 6é…ç½®æž„å»ºï¼ˆä»…360T7ï¼‰
      run: |
        cd openwrt-sdk
        cat > .config << EOF
        CONFIG_TARGET_rockchip-armv8=y
        CONFIG_PACKAGE_luci-app-openvpn-admin=y
        CONFIG_PACKAGE_easy-rsa=y
        CONFIG_PACKAGE_netcat-openbsd=y
        CONFIG_PACKAGE_openvpn-openssl=y
        CONFIG_PACKAGE_luci-lib-jsonc=y
        CONFIG_PACKAGE_luci-compat=y
        CONFIG_PACKAGE_curl=y
        CONFIG_PACKAGE_openssl-util=y
        EOF
        make defconfig || true

    - name: 7ç¼–è¯‘ä¸»æ’ä»¶ï¼ˆæ ¸å¿ƒï¼Œå¤±è´¥åˆ™ç»ˆæ­¢ï¼‰
      run: |
        cd openwrt-sdk
        echo "å¼€å§‹ç¼–è¯‘ 360T7 ä¸“å±žæ’ä»¶..."
        # ä¸»æ’ä»¶ç¼–è¯‘å¤±è´¥åˆ™ç»ˆæ­¢ï¼Œä¾èµ–å¤±è´¥å¿½ç•¥
        make package/luci-app-openvpn-admin/compile V=s IGNORE_ERRORS=1 -j$(nproc)
        # æ£€æŸ¥ä¸»æ’ä»¶æ˜¯å¦ç¼–è¯‘æˆåŠŸ
        if [ -z "$(find bin/packages -name "luci-app-openvpn-admin*.ipk" -type f)" ]; then
          echo "âŒ ä¸»æ’ä»¶ç¼–è¯‘å¤±è´¥"
          exit 1
        fi

    - name: 8å°è¯•ç¼–è¯‘ä¾èµ–åŒ…ï¼ˆå¤±è´¥å¿½ç•¥ï¼‰
      run: |
        cd openwrt-sdk
        echo "å°è¯•ç¼–è¯‘ä¾èµ–åŒ…ï¼ˆå¤±è´¥å¿½ç•¥ï¼‰..."
        # æ¯ä¸ªä¾èµ–ç¼–è¯‘å¤±è´¥éƒ½å¿½ç•¥ï¼Œä¸å½±å“ä¸»æµç¨‹
        make package/easy-rsa/compile V=s IGNORE_ERRORS=1 || echo "âš  easy-rsa ç¼–è¯‘å¤±è´¥ï¼Œå¿½ç•¥"
        make package/netcat-openbsd/compile V=s IGNORE_ERRORS=1 || echo "âš  netcat-openbsd ç¼–è¯‘å¤±è´¥ï¼Œå¿½ç•¥"
        make package/openvpn-openssl/compile V=s IGNORE_ERRORS=1 || echo "âš  openvpn-openssl ç¼–è¯‘å¤±è´¥ï¼Œå¿½ç•¥"

    - name: 9æ”¶é›†äº§ç‰©ï¼ˆä¼˜å…ˆä¸»æ’ä»¶ï¼‰
      run: |
        cd openwrt-sdk
        mkdir -p ../output-360T7
        
        # å¿…æ”¶é›†ä¸»æ’ä»¶
        MAIN_IPK=$(find bin/packages -name "luci-app-openvpn-admin*.ipk" -type f | head -1)
        if [ -n "$MAIN_IPK" ]; then
          cp "$MAIN_IPK" ../output-360T7/
          echo "âœ… ä¸»æ’ä»¶ IPK å·²æ”¶é›†"
        fi
        
        # å°è¯•æ”¶é›†ä¾èµ–ï¼ˆå¤±è´¥ä»…æç¤ºï¼‰
        for pkg in easy-rsa netcat-openbsd openvpn-openssl luci-lib-jsonc curl openssl-util; do
          DEP_IPK=$(find bin/packages -name "${pkg}*.ipk" -type f | head -1)
          if [ -n "$DEP_IPK" ]; then
            cp "$DEP_IPK" ../output-360T7/
            echo "âœ… ä¾èµ– $pkg IPK å·²æ”¶é›†"
          else
            echo "âš  ä¾èµ– $pkg IPK æœªæ‰¾åˆ°/ç¼–è¯‘å¤±è´¥ï¼Œå¿½ç•¥"
          fi
        done
        
        ls -lh ../output-360T7/

    - name: 10ä¸Šä¼ 360T7ä¸“å±žäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: openvpn-admin-360T7
        path: output-360T7/*.ipk
        retention-days: 7

    - name: 11æž„å»ºçŠ¶æ€
      if: always()
      run: |
        echo "========================================"
        echo "æž„å»ºçŠ¶æ€æŠ¥å‘Š - 360T7 (aarch64_cortex-a72)"
        echo "========================================"
        echo "ä½œä¸šçŠ¶æ€: ${{ job.status }}"
        echo "SDKä¸‹è½½çŠ¶æ€: ${{ steps.download_sdk.outcome }}"
        echo ""
        
        if [ -f "$(find output-360T7 -name "luci-app-openvpn-admin*.ipk")" ]; then
          echo "âœ… æ ¸å¿ƒæ’ä»¶ç¼–è¯‘æˆåŠŸï¼"
          echo "ðŸ“¦ äº§ç‰©åŒ…å«:"
          ls -lh output-360T7/
        else
          echo "âŒ æ ¸å¿ƒæ’ä»¶ç¼–è¯‘å¤±è´¥"
        fi
