name: ç¼–è¯‘ luci-app-openvpn-admin (X86_64)
on: 
  workflow_dispatch:  # æ‰‹åŠ¨è¿è¡Œï¼Œä¸è‡ªåŠ¨è§¦å‘

jobs:
  build-x86:
    runs-on: ubuntu-22.04
    timeout-minutes: 180
    env:
      MAKE_JOBS: 4
      SDK_URL: "https://downloads.immortalwrt.org/releases/23.05.0/targets/x86/64/immortalwrt-sdk-23.05.0-x86-64_gcc-12.3.0_musl.Linux-x86_64.tar.xz"
      DEPENDENCIES: "openssl-util curl openvpn-openssl luci-lib-jsonc luci-compat luci-base"

    steps:
      - name: 1. æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: 2. å®‰è£…ç¼–è¯‘ä¾èµ–
        run: |
          sudo apt-get update && sudo apt-get install -y build-essential libncurses5-dev gawk git wget unzip python3 python3-pip file rsync curl python3-pyelftools subversion time
          sudo pip3 install pyelftools || true

      - name: 3. ä¸‹è½½å¹¶è§£å‹ SDK
        id: sdk
        run: |
          wget --timeout=60 --tries=3 $SDK_URL -O sdk.tar.xz || { echo "SDK ä¸‹è½½å¤±è´¥"; exit 1; }
          tar xf sdk.tar.xz && mv $(find . -maxdepth 1 -type d -name "*sdk*" | head -1) openwrt-sdk
          ls -la openwrt-sdk/

      - name: 4. å‡†å¤‡æ’ä»¶æ–‡ä»¶
        run: |
          cd openwrt-sdk
          rm -rf package/luci-app-openvpn-admin && mkdir -p package/luci-app-openvpn-admin
          [ -f ../Makefile ] && cp ../Makefile package/luci-app-openvpn-admin/
          [ -d ../luasrc ] && cp -r ../luasrc package/luci-app-openvpn-admin/
          [ -d ../root ] && cp -r ../root package/luci-app-openvpn-admin/
          if [ -d ../files ]; then
            mkdir -p package/luci-app-openvpn-admin/root
            cp -r ../files/* package/luci-app-openvpn-admin/root/
          fi
          echo "==== æ’ä»¶ç›®å½•ç»“æ„ ===="
          find package/luci-app-openvpn-admin -type d | sort | head -20

      - name: 5. æ›´æ–° feeds å¹¶å®‰è£…ä¾èµ–
        run: |
          cd openwrt-sdk
          ./scripts/feeds update -a -f
          ./scripts/feeds install luci-base luci-lib-jsonc luci-compat openvpn-openssl curl openssl-util || true
          echo "==== å·²å®‰è£…çš„ feeds ===="
          ./scripts/feeds list | grep -E "luci|openvpn|curl"

      - name: 6. ç”Ÿæˆé…ç½®
        run: |
          cd openwrt-sdk
          cat > .config << EOF
          CONFIG_TARGET_x86=y
          CONFIG_TARGET_x86_64=y
          CONFIG_TARGET_x86_64_DEVICE_generic=y
          CONFIG_PACKAGE_luci-app-openvpn-admin=y
          EOF
          make defconfig
          echo "==== é…ç½®æ‘˜è¦ ===="
          grep -E "CONFIG_TARGET|CONFIG_PACKAGE|CONFIG_OPENVPN" .config

      - name: 7. ç¼–è¯‘ä¾èµ–åŒ…
        run: |
          cd openwrt-sdk
          for pkg in $DEPENDENCIES; do
            echo "==== ç¼–è¯‘ $pkg ===="
            pkg_path=$(find package feeds -name $pkg -type d | head -1)
            if [ -n "$pkg_path" ]; then
              make package/$pkg/compile V=sc -j$MAKE_JOBS || echo "âš  $pkg ç¼–è¯‘å¤±è´¥ï¼Œè·³è¿‡ï¼ˆéå…³é”®ï¼‰"
            else
              echo "âš  $pkg åœ¨ feeds ä¸­æœªæ‰¾åˆ°ï¼Œè·³è¿‡"
            fi
          done

      - name: 8. ç¼–è¯‘ä¸»æ’ä»¶
        run: |
          cd openwrt-sdk
          [ ! -d "package/luci-app-openvpn-admin" ] && { echo "æ’ä»¶ç›®å½•ç¼ºå¤±"; exit 1; }
          make package/luci-app-openvpn-admin/clean
          make package/luci-app-openvpn-admin/compile V=s -j$MAKE_JOBS 2>&1 | tee compile-log.txt
          MAIN_IPK=$(find bin -name "*luci-app-openvpn-admin*.ipk" -type f | head -1)
          if [ -z "$MAIN_IPK" ]; then
            echo "==== ç¼–è¯‘æ—¥å¿—ï¼ˆæœ€å100è¡Œï¼‰===="
            tail -100 compile-log.txt
            echo "âŒ ä¸»æ’ä»¶ç¼–è¯‘å¤±è´¥"
          else
            echo "âœ… ä¸»æ’ä»¶ç¼–è¯‘æˆåŠŸ: $MAIN_IPK"
          fi

      - name: 9. è°ƒè¯• - æŸ¥æ‰¾æ‰€æœ‰ç¼–è¯‘è¾“å‡º
        run: |
          cd openwrt-sdk
          echo "==== æœç´¢æ‰€æœ‰ IPK æ–‡ä»¶ ===="
          find . -name "*.ipk" -type f 2>/dev/null | sort
          
          echo "==== æŸ¥çœ‹ bin ç›®å½•ç»“æ„ ===="
          find bin -type f 2>/dev/null | head -30
          
          echo "==== æŸ¥çœ‹ packages ç›®å½• ===="
          find bin/packages -name "*.ipk" 2>/dev/null | grep -i openvpn
          
          echo "==== æ£€æŸ¥ç¼–è¯‘æ—¥å¿—ä¸­çš„é”™è¯¯ ===="
          if [ -f compile-log.txt ]; then
            grep -i "error\|failed\|cannot\|undefined" compile-log.txt | head -20
          fi

      - name: 10. è°ƒè¯• - æ£€æŸ¥æ’ä»¶ç›®å½•çŠ¶æ€
        run: |
          cd openwrt-sdk/package/luci-app-openvpn-admin
          echo "==== æ’ä»¶ç›®å½•å†…å®¹ ===="
          ls -la
          echo "==== Makefile å†…å®¹ ===="
          cat Makefile 2>/dev/null || echo "Makefile æœªæ‰¾åˆ°"
          echo "==== ç›®å½•ç»“æ„ ===="
          find . -type d | sort

      - name: 11. æ”¶é›†ç¼–è¯‘äº§ç‰©
        run: |
          cd openwrt-sdk
          
          echo "==== æŸ¥æ‰¾æ‰€æœ‰ IPK æ–‡ä»¶ ===="
          find . -name "*.ipk" -type f 2>/dev/null > all_ipks.txt
          echo "æ‰¾åˆ°çš„ IPK æ–‡ä»¶:"
          cat all_ipks.txt
          
          mkdir -p ../output-x86_64
          
          while IFS= read -r ipk_path; do
            if [ -f "$ipk_path" ]; then
              filename=$(basename "$ipk_path")
              echo "å¤åˆ¶: $filename"
              cp "$ipk_path" ../output-x86_64/
            fi
          done < all_ipks.txt
          
          echo "==== è¾“å‡ºç›®å½•å†…å®¹ ===="
          ls -lh ../output-x86_64/
          
          echo "==== æŒ‰æ–‡ä»¶å¤§å°æ’åº ===="
          ls -lhS ../output-x86_64/ | head -10
          
          MAIN_IPK=$(find ../output-x86_64 -name "*luci-app-openvpn-admin*.ipk" 2>/dev/null | head -1)
          if [ -z "$MAIN_IPK" ]; then
            echo "è­¦å‘Šï¼šæœªæ‰¾åˆ°ä¸»æ’ä»¶ IPKï¼Œå°è¯•å…¶ä»–æ¨¡å¼..."
            find ../output-x86_64 -name "*openvpn*.ipk" 2>/dev/null
            if [ -f package/luci-app-openvpn-admin/Makefile ]; then
              echo "==== Makefile ä¸­çš„åŒ…åå®šä¹‰ ===="
              grep -i "PKG_NAME\|PKG_TITLE" package/luci-app-openvpn-admin/Makefile
            fi
          else
            echo "âœ… æ‰¾åˆ°ä¸»æ’ä»¶: $(basename $MAIN_IPK)"
            echo "IPK å†…å®¹ç»“æ„:"
            tar -tzf $MAIN_IPK | head -20
          fi

      - name: 12. æ¸…ç†ç¼“å­˜ï¼ˆå¯é€‰ï¼‰
        run: |
          echo "==== å¼€å§‹æ¸…ç†ç¼“å­˜ ===="
          cd openwrt-sdk
          # æ¸…ç†ç¼–è¯‘ç¼“å­˜ï¼Œå‡å°‘ç©ºé—´å ç”¨
          make clean || echo "æ¸…ç†å¤±è´¥ï¼Œç»§ç»­æ‰§è¡Œ"
          
          # åˆ é™¤ä¸‹è½½çš„æºç ç¼“å­˜
          rm -rf dl/* build_dir/* staging_dir/* tmp/* 2>/dev/null || true
          
          # æ¸…ç†æ—¥å¿—æ–‡ä»¶
          rm -f compile-log.txt 2>/dev/null || true
          
          echo "æ¸…ç†å®Œæˆï¼Œå‰©ä½™ç©ºé—´:"
          df -h

      - name: 13. ä¸Šä¼ ç¼–è¯‘äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: openvpn-admin-x86_64
          path: output-x86_64/
          retention-days: 7

      - name: 14. æ„å»ºæŠ¥å‘Š
        if: always()
        run: |
          echo "========================================"
          echo "æ„å»ºçŠ¶æ€æŠ¥å‘Š - X86_64"
          echo "========================================"
          echo "æ¶æ„ï¼šx86_64 (64ä½)"
          echo "å›ºä»¶ç‰ˆæœ¬ï¼šImmortalWrt 23.05.0"
          echo "ä½œä¸šçŠ¶æ€: ${{ job.status }}"
          echo "SDK ä¸‹è½½çŠ¶æ€: ${{ steps.sdk.outcome }}"
          echo ""
          if [ -d output-x86_64 ]; then
            IPK_COUNT=$(find output-x86_64 -name "*.ipk" 2>/dev/null | wc -l)
            echo "ğŸ“¦ ç”Ÿæˆçš„ IPK æ•°é‡: $IPK_COUNT"
            echo "ğŸ“‹ IPK åˆ—è¡¨:"
            ls -lh output-x86_64/
            MAIN_IPK=$(find output-x86_64 -name "*luci-app-openvpn-admin*.ipk" 2>/dev/null | head -1)
            if [ -n "$MAIN_IPK" ]; then
              echo "âœ… æ ¸å¿ƒæ’ä»¶: $(basename $MAIN_IPK)"
              echo "ğŸ“Š æ–‡ä»¶å¤§å°: $(du -h $MAIN_IPK | cut -f1)"
              echo "ğŸ” æ¶æ„ä¿¡æ¯:"
              tar -xzOf $MAIN_IPK ./control.tar.gz 2>/dev/null | tar -xzO ./control 2>/dev/null | grep -E "Architecture|Version|Package" || echo "æ— æ³•æå–æ§åˆ¶ä¿¡æ¯"
            else
              echo "âŒ æ ¸å¿ƒæ’ä»¶ç¼–è¯‘å¤±è´¥"
              echo "å°è¯•æŸ¥æ‰¾å…¶ä»– openvpn ç›¸å…³åŒ…:"
              find output-x86_64 -name "*openvpn*.ipk" 2>/dev/null || echo "æœªæ‰¾åˆ°"
            fi
          else
            echo "âŒ è¾“å‡ºç›®å½•ä¸å­˜åœ¨"
          fi
