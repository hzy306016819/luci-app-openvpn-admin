name: Build and Release luci-app-openvpn-admin (X86_64)
on: 
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: v1.0.0)'
        required: true
        default: 'v1.0.0'
      prerelease:
        description: 'æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬'
        required: true
        default: false
        type: boolean
  push:
    tags:
      - 'v*'

jobs:
  build-x86:
    runs-on: ubuntu-22.04
    timeout-minutes: 180
    env:
      MAKE_JOBS: 4
      SDK_URL: "https://downloads.immortalwrt.org/releases/23.05.0/targets/x86/64/immortalwrt-sdk-23.05.0-x86-64_gcc-12.3.0_musl.Linux-x86_64.tar.xz"
      DEPENDENCIES: "openssl-util curl openvpn-openssl luci-lib-jsonc luci-compat luci-base"

    steps:
      - name: 1. Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 2. Install build dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y build-essential libncurses5-dev gawk git wget unzip python3 python3-pip file rsync curl python3-pyelftools subversion time
          sudo pip3 install pyelftools || true

      - name: 3. Download & extract ImmortalWrt SDK
        id: sdk
        run: |
          wget --timeout=60 --tries=3 $SDK_URL -O sdk.tar.xz || { echo "SDK download failed"; exit 1; }
          tar xf sdk.tar.xz && mv $(find . -maxdepth 1 -type d -name "*sdk*" | head -1) openwrt-sdk
          ls -la openwrt-sdk/

      - name: 4. Prepare package files
        run: |
          cd openwrt-sdk
          rm -rf package/luci-app-openvpn-admin && mkdir -p package/luci-app-openvpn-admin
          [ -f ../Makefile ] && cp ../Makefile package/luci-app-openvpn-admin/
          [ -d ../luasrc ] && cp -r ../luasrc package/luci-app-openvpn-admin/
          [ -d ../root ] && cp -r ../root package/luci-app-openvpn-admin/
          if [ -d ../files ]; then
            mkdir -p package/luci-app-openvpn-admin/root
            cp -r ../files/* package/luci-app-openvpn-admin/root/
          fi
          echo "==== Package dir structure ===="
          find package/luci-app-openvpn-admin -type d | sort | head -20

      - name: 5. Update feeds & install dependencies
        run: |
          cd openwrt-sdk
          ./scripts/feeds update -a -f
          ./scripts/feeds install luci-base luci-lib-jsonc luci-compat openvpn-openssl curl openssl-util || true
          echo "==== Installed feeds ===="
          ./scripts/feeds list | grep -E "luci|openvpn|curl"

      - name: 6. Generate .config
        run: |
          cd openwrt-sdk
          cat > .config << EOF
          CONFIG_TARGET_x86=y
          CONFIG_TARGET_x86_64=y
          CONFIG_TARGET_x86_64_DEVICE_generic=y
          CONFIG_PACKAGE_luci-app-openvpn-admin=y
          EOF
          make defconfig
          echo "==== é…ç½®æ‘˜è¦ ===="
          grep -E "CONFIG_TARGET|CONFIG_PACKAGE|CONFIG_OPENVPN" .config

      - name: 7. Compile dependencies
        run: |
          cd openwrt-sdk
          for pkg in $DEPENDENCIES; do
            echo "==== Compiling $pkg ===="
            pkg_path=$(find package feeds -name $pkg -type d | head -1)
            if [ -n "$pkg_path" ]; then
              make package/$pkg/compile V=sc -j$MAKE_JOBS || echo "âš  $pkg compile failed, skip (non-critical)"
            else
              echo "âš  $pkg not found in feeds, skip"
            fi
          done

      - name: 8. Compile main package
        run: |
          cd openwrt-sdk
          [ ! -d "package/luci-app-openvpn-admin" ] && { echo "Package dir missing"; exit 1; }
          make package/luci-app-openvpn-admin/clean
          make package/luci-app-openvpn-admin/compile V=s -j$MAKE_JOBS 2>&1 | tee compile-log.txt
          MAIN_IPK=$(find bin -name "*luci-app-openvpn-admin*.ipk" -type f | head -1)
          if [ -z "$MAIN_IPK" ]; then
            echo "==== Compile log (last 100 lines) ===="
            tail -100 compile-log.txt
            echo "âŒ Main package compile failed"
            exit 1
          else
            echo "âœ… Main package compiled: $MAIN_IPK"
          fi

      - name: 9. Collect and prepare release artifacts
        id: prepare-release
        run: |
          cd openwrt-sdk
          
          # æŸ¥æ‰¾ä¸»æ’ä»¶IPK
          MAIN_IPK=$(find . -name "*luci-app-openvpn-admin*.ipk" -type f 2>/dev/null | head -1)
          
          if [ -z "$MAIN_IPK" ]; then
            echo "âŒ æœªæ‰¾åˆ°ä¸»æ’ä»¶IPK"
            exit 1
          fi
          
          # è·å–IPKè¯¦ç»†ä¿¡æ¯
          IPK_NAME=$(basename "$MAIN_IPK")
          IPK_SIZE=$(du -h "$MAIN_IPK" | cut -f1)
          
          # æå–ç‰ˆæœ¬ä¿¡æ¯
          if tar -xzOf "$MAIN_IPK" ./control.tar.gz 2>/dev/null | tar -xzO ./control 2>/dev/null > /tmp/control; then
            PKG_VERSION=$(grep -i "^Version:" /tmp/control | cut -d' ' -f2)
            PKG_ARCH=$(grep -i "^Architecture:" /tmp/control | cut -d' ' -f2)
          else
            PKG_VERSION="unknown"
            PKG_ARCH="unknown"
          fi
          
          # åˆ›å»ºreleaseç›®å½•
          mkdir -p ../release-artifacts
          cp "$MAIN_IPK" ../release-artifacts/
          
          # åˆ›å»ºè¯´æ˜æ–‡ä»¶
          cat > ../release-artifacts/README.md << EOF
          # luci-app-openvpn-admin - X86_64 ç‰ˆæœ¬
          
          ## æ’ä»¶ä¿¡æ¯
          - **æ–‡ä»¶å**: ${IPK_NAME}
          - **ç‰ˆæœ¬**: ${PKG_VERSION}
          - **æ¶æ„**: ${PKG_ARCH}
          - **å¤§å°**: ${IPK_SIZE}
          - **ç¼–è¯‘æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')
          
          ## å®‰è£…æ–¹æ³•
          
          \`\`\`bash
          # ä¸Šä¼ åˆ°è·¯ç”±å™¨
          scp ${IPK_NAME} root@è·¯ç”±å™¨IP:/tmp/
          
          # å®‰è£…
          opkg install /tmp/${IPK_NAME}
          
          # å¦‚æœä¾èµ–ç¼ºå¤±ï¼Œå…ˆå®‰è£…ä¾èµ–
          opkg install curl openvpn-openssl openssl-util luci-lib-jsonc luci-compat
          \`\`\`
          
          ## æ”¯æŒçš„å›ºä»¶
          - ImmortalWrt 23.05.0
          - OpenWrt 23.05.x
          - å…¶ä»–åŸºäºmuslçš„x86_64å›ºä»¶
          
          ## æ³¨æ„äº‹é¡¹
          1. ç¡®ä¿è·¯ç”±å™¨æœ‰è¶³å¤Ÿçš„ç©ºé—´
          2. å®‰è£…åéœ€è¦é‡å¯luciç•Œé¢æˆ–è·¯ç”±å™¨
          3. é…ç½®å‰è¯·ç¡®ä¿å·²å®‰è£…å¹¶é…ç½®å¥½OpenVPN
          EOF
          
          # è¾“å‡ºä¿¡æ¯ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "IPK_PATH=$MAIN_IPK" >> $GITHUB_OUTPUT
          echo "IPK_NAME=$IPK_NAME" >> $GITHUB_OUTPUT
          echo "PKG_VERSION=$PKG_VERSION" >> $GITHUB_OUTPUT
          echo "PKG_ARCH=$PKG_ARCH" >> $GITHUB_OUTPUT
          
          echo "âœ… å‡†å¤‡å‘å¸ƒæ–‡ä»¶å®Œæˆ"
          echo "ğŸ“¦ æ–‡ä»¶: $IPK_NAME"
          echo "ğŸ·ï¸ ç‰ˆæœ¬: $PKG_VERSION"
          echo "ğŸ—ï¸ æ¶æ„: $PKG_ARCH"

      - name: 10. Create GitHub Release
        if: success() && github.event_name == 'workflow_dispatch'
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.version }}
          name: luci-app-openvpn-admin ${{ github.event.inputs.version }} (X86_64)
          body: |
            # luci-app-openvpn-admin - X86_64 ç‰ˆæœ¬
            
            ## ç‰ˆæœ¬ä¿¡æ¯
            - **ç¼–è¯‘æ—¶é—´**: $(date -u +'%Y-%m-%dT%H:%M:%SZ')
            - **æ¶æ„**: ${{ steps.prepare-release.outputs.PKG_ARCH }}
            - **æ’ä»¶ç‰ˆæœ¬**: ${{ steps.prepare-release.outputs.PKG_VERSION }}
            
            ## å®‰è£…è¯´æ˜
            
            1. ä¸‹è½½å¯¹åº”çš„IPKæ–‡ä»¶
            2. ä¸Šä¼ åˆ°è·¯ç”±å™¨:
            ```bash
            scp ${{ steps.prepare-release.outputs.IPK_NAME }} root@è·¯ç”±å™¨IP:/tmp/
            ```
            
            3. å®‰è£…æ’ä»¶:
            ```bash
            opkg install /tmp/${{ steps.prepare-release.outputs.IPK_NAME }}
            ```
            
            ## ä¾èµ–è¦æ±‚
            - openssl-util
            - curl
            - openvpn-openssl
            - luci-lib-jsonc
            - luci-compat
            - luci-base
            
            ## æ”¯æŒçš„å›ºä»¶
            - ImmortalWrt 23.05.0 (x86_64)
            - OpenWrt 23.05.x (x86_64)
            
            ## æºç 
            æºç ä»“åº“: https://github.com/${{ github.repository }}
            
          draft: false
          prerelease: ${{ github.event.inputs.prerelease }}
          generate_release_notes: true
          files: |
            release-artifacts/${{ steps.prepare-release.outputs.IPK_NAME }}
            release-artifacts/README.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: 11. Create Tagged Release
        if: success() && github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
        id: create_tagged_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: luci-app-openvpn-admin ${{ github.ref_name }} (X86_64)
          body: |
            # luci-app-openvpn-admin - X86_64 ç‰ˆæœ¬
            
            ## ç‰ˆæœ¬ä¿¡æ¯
            - **æ ‡ç­¾**: ${{ github.ref_name }}
            - **ç¼–è¯‘æ—¶é—´**: $(date -u +'%Y-%m-%dT%H:%M:%SZ')
            - **æ¶æ„**: ${{ steps.prepare-release.outputs.PKG_ARCH }}
            - **æ’ä»¶ç‰ˆæœ¬**: ${{ steps.prepare-release.outputs.PKG_VERSION }}
            
            ## å®‰è£…è¯´æ˜
            
            è¯¦è§é™„å¸¦çš„README.mdæ–‡ä»¶
            
            ## æºç 
            æºç ä»“åº“: https://github.com/${{ github.repository }}
            æœ¬æ¬¡æäº¤: ${{ github.sha }}
            
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            release-artifacts/${{ steps.prepare-release.outputs.IPK_NAME }}
            release-artifacts/README.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: 12. Upload artifacts as backup
        uses: actions/upload-artifact@v4
        with:
          name: openvpn-admin-x86_64-${{ github.run_id }}
          path: |
            release-artifacts/
            openwrt-sdk/compile-log.txt
          retention-days: 30

      - name: 13. Build report
        if: always()
        run: |
          echo "========================================"
          echo "æ„å»ºçŠ¶æ€æŠ¥å‘Š - X86_64"
          echo "========================================"
          echo "ä½œä¸šçŠ¶æ€: ${{ job.status }}"
          echo "è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "ç‰ˆæœ¬å·: ${{ github.event.inputs.version }}"
            echo "é¢„å‘å¸ƒ: ${{ github.event.inputs.prerelease }}"
          elif [ "${{ github.event_name }}" = "push" ]; then
            echo "æ ‡ç­¾: ${{ github.ref_name }}"
          fi
          
          echo ""
          if [ -d release-artifacts ]; then
            echo "ğŸ“¦ å‘å¸ƒæ–‡ä»¶:"
            ls -lh release-artifacts/
            
            if [ -f release-artifacts/README.md ]; then
              echo ""
              echo "ğŸ“„ READMEå†…å®¹æ‘˜è¦:"
              head -20 release-artifacts/README.md
            fi
          else
            echo "âŒ å‘å¸ƒç›®å½•ä¸å­˜åœ¨"
          fi
