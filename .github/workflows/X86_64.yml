name: æ„å»ºå¹¶å‘å¸ƒ luci-app-openvpn-admin (X86_64ç‰ˆ)
on: 
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: v1.0.0)'
        required: true
        default: 'v1.0.0'
      prerelease:
        description: 'æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬'
        required: true
        default: false
        type: boolean
  push:
    tags:
      - 'v*'

jobs:
  æ„å»ºæ’ä»¶:
    runs-on: ubuntu-22.04
    timeout-minutes: 180
    env:
      ç¼–è¯‘çº¿ç¨‹æ•°: 4
      SDKä¸‹è½½åœ°å€: "https://downloads.immortalwrt.org/releases/23.05.0/targets/x86/64/immortalwrt-sdk-23.05.0-x86-64_gcc-12.3.0_musl.Linux-x86_64.tar.xz"
      ä¾èµ–åŒ…åˆ—è¡¨: "openssl-util curl openvpn-openssl luci-lib-jsonc luci-compat luci-base"

    steps:
      - name: 1. æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 2. å®‰è£…ç¼–è¯‘ä¾èµ–
        run: |
          sudo apt-get update && sudo apt-get install -y build-essential libncurses5-dev gawk git wget unzip python3 python3-pip file rsync curl python3-pyelftools subversion time
          sudo pip3 install pyelftools || true

      - name: 3. ä¸‹è½½å¹¶è§£å‹ ImmortalWrt SDK
        id: sdk
        run: |
          wget --timeout=60 --tries=3 $SDKä¸‹è½½åœ°å€ -O sdk.tar.xz || { echo "SDKä¸‹è½½å¤±è´¥"; exit 1; }
          tar xf sdk.tar.xz && mv $(find . -maxdepth 1 -type d -name "*sdk*" | head -1) openwrt-sdk
          echo "SDKç›®å½•å†…å®¹:"
          ls -la openwrt-sdk/

      - name: 4. å‡†å¤‡æ’ä»¶æ–‡ä»¶
        run: |
          cd openwrt-sdk
          # æ¸…ç†æ—§ç›®å½•ï¼Œåˆ›å»ºæ–°ç›®å½•
          rm -rf package/luci-app-openvpn-admin && mkdir -p package/luci-app-openvpn-admin
          # å¤åˆ¶ä¿®æ­£åçš„ Makefile
          [ -f ../Makefile ] && cp ../Makefile package/luci-app-openvpn-admin/
          # å¤åˆ¶ luasrc/root ç›®å½•ï¼ˆæ–°ç»“æ„ï¼‰ï¼Œè€Œé files ç›®å½•
          [ -d ../luasrc ] && cp -r ../luasrc package/luci-app-openvpn-admin/
          [ -d ../root ] && cp -r ../root package/luci-app-openvpn-admin/
          # å…¼å®¹æ—§ files ç›®å½•
          if [ -d ../files ]; then
            mkdir -p package/luci-app-openvpn-admin/root
            cp -r ../files/* package/luci-app-openvpn-admin/root/
          fi
          echo "==== æ’ä»¶ç›®å½•ç»“æ„ ===="
          find package/luci-app-openvpn-admin -type d | sort | head -20

      - name: 5. æ›´æ–°è½¯ä»¶æºå¹¶å®‰è£…ä¾èµ–
        run: |
          cd openwrt-sdk
          ./scripts/feeds update -a -f
          ./scripts/feeds install luci-base luci-lib-jsonc luci-compat openvpn-openssl curl openssl-util || true
          echo "==== å·²å®‰è£…çš„è½¯ä»¶æº ===="
          ./scripts/feeds list | grep -E "luci|openvpn|curl"

      - name: 6. ç”Ÿæˆç¼–è¯‘é…ç½®
        run: |
          cd openwrt-sdk
          cat > .config << EOF
          CONFIG_TARGET_x86=y
          CONFIG_TARGET_x86_64=y
          CONFIG_TARGET_x86_64_DEVICE_generic=y
          CONFIG_PACKAGE_luci-app-openvpn-admin=y
          EOF
          make defconfig
          echo "==== é…ç½®æ‘˜è¦ ===="
          grep -E "CONFIG_TARGET|CONFIG_PACKAGE|CONFIG_OPENVPN" .config

      - name: 7. ç¼–è¯‘ä¾èµ–åŒ…
        run: |
          cd openwrt-sdk
          for pkg in $ä¾èµ–åŒ…åˆ—è¡¨; do
            echo "==== æ­£åœ¨ç¼–è¯‘ $pkg ===="
            pkg_path=$(find package feeds -name $pkg -type d | head -1)
            if [ -n "$pkg_path" ]; then
              make package/$pkg/compile V=sc -j$ç¼–è¯‘çº¿ç¨‹æ•° || echo "âš  $pkg ç¼–è¯‘å¤±è´¥ï¼Œè·³è¿‡ï¼ˆéå…³é”®ä¾èµ–ï¼‰"
            else
              echo "âš  $pkg åœ¨è½¯ä»¶æºä¸­æœªæ‰¾åˆ°ï¼Œè·³è¿‡"
            fi
          done

      - name: 8. ç¼–è¯‘ä¸»æ’ä»¶åŒ…
        run: |
          cd openwrt-sdk
          [ ! -d "package/luci-app-openvpn-admin" ] && { echo "æ’ä»¶ç›®å½•ä¸å­˜åœ¨"; exit 1; }
          make package/luci-app-openvpn-admin/clean
          echo "å¼€å§‹ç¼–è¯‘ä¸»æ’ä»¶ï¼Œè¯¦ç»†æ—¥å¿—å¦‚ä¸‹ï¼š"
          make package/luci-app-openvpn-admin/compile V=s -j$ç¼–è¯‘çº¿ç¨‹æ•° 2>&1 | tee compile-log.txt
          
          # æ£€æŸ¥ç¼–è¯‘ç»“æœ
          ä¸»æ’ä»¶æ–‡ä»¶=$(find bin -name "*luci-app-openvpn-admin*.ipk" -type f | head -1)
          if [ -z "$ä¸»æ’ä»¶æ–‡ä»¶" ]; then
            echo "==== ç¼–è¯‘æ—¥å¿—ï¼ˆæœ€å100è¡Œï¼‰ ===="
            tail -100 compile-log.txt
            echo "âŒ ä¸»æ’ä»¶ç¼–è¯‘å¤±è´¥"
            exit 1
          else
            echo "âœ… ä¸»æ’ä»¶ç¼–è¯‘æˆåŠŸ: $ä¸»æ’ä»¶æ–‡ä»¶"
          fi

      - name: 9. æ”¶é›†å¹¶å‡†å¤‡å‘å¸ƒæ–‡ä»¶
        id: å‡†å¤‡å‘å¸ƒ
        run: |
          cd openwrt-sdk
          
          # æŸ¥æ‰¾ä¸»æ’ä»¶IPK
          ä¸»æ’ä»¶æ–‡ä»¶=$(find . -name "*luci-app-openvpn-admin*.ipk" -type f 2>/dev/null | head -1)
          
          if [ -z "$ä¸»æ’ä»¶æ–‡ä»¶" ]; then
            echo "âŒ æœªæ‰¾åˆ°ä¸»æ’ä»¶IPKæ–‡ä»¶"
            exit 1
          fi
          
          # è·å–IPKè¯¦ç»†ä¿¡æ¯
          æ’ä»¶æ–‡ä»¶å=$(basename "$ä¸»æ’ä»¶æ–‡ä»¶")
          æ’ä»¶å¤§å°=$(du -h "$ä¸»æ’ä»¶æ–‡ä»¶" | cut -f1)
          
          # æå–ç‰ˆæœ¬ä¿¡æ¯
          if tar -xzOf "$ä¸»æ’ä»¶æ–‡ä»¶" ./control.tar.gz 2>/dev/null | tar -xzO ./control 2>/dev/null > /tmp/control; then
            æ’ä»¶ç‰ˆæœ¬=$(grep -i "^Version:" /tmp/control | cut -d' ' -f2)
            æ’ä»¶æ¶æ„=$(grep -i "^Architecture:" /tmp/control | cut -d' ' -f2)
          else
            æ’ä»¶ç‰ˆæœ¬="æœªçŸ¥"
            æ’ä»¶æ¶æ„="æœªçŸ¥"
          fi
          
          # åˆ›å»ºå‘å¸ƒç›®å½•
          mkdir -p ../release-artifacts
          cp "$ä¸»æ’ä»¶æ–‡ä»¶" ../release-artifacts/
          
          # å¤åˆ¶ç¼–è¯‘æ—¥å¿—ç”¨äºè°ƒè¯•
          cp compile-log.txt ../release-artifacts/ç¼–è¯‘æ—¥å¿—.txt
          
          # åˆ›å»ºè¯´æ˜æ–‡ä»¶
          cat > ../release-artifacts/README.md << EOF
          # luci-app-openvpn-admin - X86_64 ç‰ˆæœ¬
          
          ## æ’ä»¶ä¿¡æ¯
          - **æ–‡ä»¶å**: ${æ’ä»¶æ–‡ä»¶å}
          - **ç‰ˆæœ¬**: ${æ’ä»¶ç‰ˆæœ¬}
          - **æ¶æ„**: ${æ’ä»¶æ¶æ„}
          - **å¤§å°**: ${æ’ä»¶å¤§å°}
          - **ç¼–è¯‘æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')
          - **GitHub Actions ID**: ${{ github.run_id }}
          
          ## å®‰è£…æ–¹æ³•
          
          \`\`\`bash
          # ä¸Šä¼ åˆ°è·¯ç”±å™¨
          scp ${æ’ä»¶æ–‡ä»¶å} root@è·¯ç”±å™¨IP:/tmp/
          
          # å®‰è£…
          opkg install /tmp/${æ’ä»¶æ–‡ä»¶å}
          
          # å¦‚æœä¾èµ–ç¼ºå¤±ï¼Œå…ˆå®‰è£…ä¾èµ–
          opkg install curl openvpn-openssl openssl-util luci-lib-jsonc luci-compat
          \`\`\`
          
          ## æ”¯æŒçš„å›ºä»¶
          - ImmortalWrt 23.05.0
          - OpenWrt 23.05.x
          - å…¶ä»–åŸºäºmuslçš„x86_64å›ºä»¶
          
          ## æ³¨æ„äº‹é¡¹
          1. ç¡®ä¿è·¯ç”±å™¨æœ‰è¶³å¤Ÿçš„ç©ºé—´
          2. å®‰è£…åéœ€è¦é‡å¯luciç•Œé¢æˆ–è·¯ç”±å™¨
          3. é…ç½®å‰è¯·ç¡®ä¿å·²å®‰è£…å¹¶é…ç½®å¥½OpenVPN
          EOF
          
          # è¾“å‡ºä¿¡æ¯ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "IPKè·¯å¾„=$ä¸»æ’ä»¶æ–‡ä»¶" >> $GITHUB_OUTPUT
          echo "IPKåç§°=$æ’ä»¶æ–‡ä»¶å" >> $GITHUB_OUTPUT
          echo "æ’ä»¶ç‰ˆæœ¬=$æ’ä»¶ç‰ˆæœ¬" >> $GITHUB_OUTPUT
          echo "æ’ä»¶æ¶æ„=$æ’ä»¶æ¶æ„" >> $GITHUB_OUTPUT
          
          echo "âœ… å‘å¸ƒæ–‡ä»¶å‡†å¤‡å®Œæˆ"
          echo "ğŸ“¦ æ–‡ä»¶: $æ’ä»¶æ–‡ä»¶å"
          echo "ğŸ·ï¸ ç‰ˆæœ¬: $æ’ä»¶ç‰ˆæœ¬"
          echo "ğŸ—ï¸ æ¶æ„: $æ’ä»¶æ¶æ„"

      - name: 10. åˆ›å»ºGitHub Releaseï¼ˆæ‰‹åŠ¨è§¦å‘ï¼‰
        if: success() && github.event_name == 'workflow_dispatch'
        id: åˆ›å»ºå‘å¸ƒ
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.version }}
          name: luci-app-openvpn-admin ${{ github.event.inputs.version }} (X86_64)
          body: |
            # luci-app-openvpn-admin - X86_64 ç‰ˆæœ¬
            
            ## ç‰ˆæœ¬ä¿¡æ¯
            - **ç¼–è¯‘æ—¶é—´**: $(date -u +'%Y-%m-%dT%H:%M:%SZ')
            - **æ¶æ„**: ${{ steps.å‡†å¤‡å‘å¸ƒ.outputs.æ’ä»¶æ¶æ„ }}
            - **æ’ä»¶ç‰ˆæœ¬**: ${{ steps.å‡†å¤‡å‘å¸ƒ.outputs.æ’ä»¶ç‰ˆæœ¬ }}
            
            ## å®‰è£…è¯´æ˜
            
            1. ä¸‹è½½å¯¹åº”çš„IPKæ–‡ä»¶
            2. ä¸Šä¼ åˆ°è·¯ç”±å™¨:
            ```bash
            scp ${{ steps.å‡†å¤‡å‘å¸ƒ.outputs.IPKåç§° }} root@è·¯ç”±å™¨IP:/tmp/
            ```
            
            3. å®‰è£…æ’ä»¶:
            ```bash
            opkg install /tmp/${{ steps.å‡†å¤‡å‘å¸ƒ.outputs.IPKåç§° }}
            ```
            
            ## ä¾èµ–è¦æ±‚
            - openssl-util
            - curl
            - openvpn-openssl
            - luci-lib-jsonc
            - luci-compat
            - luci-base
            
            ## æ”¯æŒçš„å›ºä»¶
            - ImmortalWrt 23.05.0 (x86_64)
            - OpenWrt 23.05.x (x86_64)
            
            ## æºç 
            æºç ä»“åº“: https://github.com/${{ github.repository }}
            
          draft: false
          prerelease: ${{ github.event.inputs.prerelease }}
          generate_release_notes: true
          files: |
            release-artifacts/${{ steps.å‡†å¤‡å‘å¸ƒ.outputs.IPKåç§° }}
            release-artifacts/README.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: 11. åˆ›å»ºæ ‡ç­¾Releaseï¼ˆæ ‡ç­¾è§¦å‘ï¼‰
        if: success() && github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
        id: åˆ›å»ºæ ‡ç­¾å‘å¸ƒ
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: luci-app-openvpn-admin ${{ github.ref_name }} (X86_64)
          body: |
            # luci-app-openvpn-admin - X86_64 ç‰ˆæœ¬
            
            ## ç‰ˆæœ¬ä¿¡æ¯
            - **æ ‡ç­¾**: ${{ github.ref_name }}
            - **ç¼–è¯‘æ—¶é—´**: $(date -u +'%Y-%m-%dT%H:%M:%SZ')
            - **æ¶æ„**: ${{ steps.å‡†å¤‡å‘å¸ƒ.outputs.æ’ä»¶æ¶æ„ }}
            - **æ’ä»¶ç‰ˆæœ¬**: ${{ steps.å‡†å¤‡å‘å¸ƒ.outputs.æ’ä»¶ç‰ˆæœ¬ }}
            
            ## å®‰è£…è¯´æ˜
            
            è¯¦è§é™„å¸¦çš„README.mdæ–‡ä»¶
            
            ## æºç 
            æºç ä»“åº“: https://github.com/${{ github.repository }}
            æœ¬æ¬¡æäº¤: ${{ github.sha }}
            
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            release-artifacts/${{ steps.å‡†å¤‡å‘å¸ƒ.outputs.IPKåç§° }}
            release-artifacts/README.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: 12. ä¸Šä¼ æ„å»ºäº§ç‰©ï¼ˆå¤‡ä»½ï¼‰
        uses: actions/upload-artifact@v4
        with:
          name: openvpn-admin-x86_64-${{ github.run_id }}
          path: |
            release-artifacts/
            openwrt-sdk/compile-log.txt
          retention-days: 30

      - name: 13. æ¸…ç†å·¥ä½œç©ºé—´ï¼ˆç¼“å­˜å’Œä¸­é—´æ–‡ä»¶ï¼‰
        if: always()
        run: |
          echo "==== å¼€å§‹æ¸…ç†å·¥ä½œç©ºé—´ ===="
          
          # 1. è®¡ç®—æ¸…ç†å‰ç£ç›˜ä½¿ç”¨æƒ…å†µ
          echo "æ¸…ç†å‰ç£ç›˜ä½¿ç”¨æƒ…å†µ:"
          df -h
          echo "æ¸…ç†å‰å·¥ä½œç©ºé—´å¤§å°:"
          du -sh . || true
          
          # 2. åˆ é™¤OpenWrt SDKç¼–è¯‘äº§ç”Ÿçš„ä¸­é—´æ–‡ä»¶ï¼ˆè¿™äº›æ–‡ä»¶å ç©ºé—´æœ€å¤§ï¼‰
          if [ -d "openwrt-sdk" ]; then
            echo "æ¸…ç†OpenWrt SDKä¸­é—´æ–‡ä»¶..."
            cd openwrt-sdk
            
            # åˆ é™¤ç¼–è¯‘äº§ç”Ÿçš„ä¸­é—´ç›®å½•ï¼ˆè¿™äº›å ç©ºé—´æœ€å¤§ï¼‰
            rm -rf build_dir 2>/dev/null || true
            rm -rf staging_dir 2>/dev/null || true
            rm -rf tmp 2>/dev/null || true
            rm -rf logs 2>/dev/null || true
            
            # ä¿ç•™binç›®å½•ï¼ˆåŒ…å«ç¼–è¯‘å¥½çš„IPKï¼‰
            cd ..
          fi
          
          # 3. æ¸…ç†ç³»ç»Ÿç¼“å­˜
          echo "æ¸…ç†APTç¼“å­˜..."
          sudo apt-get clean 2>/dev/null || true
          sudo rm -rf /var/lib/apt/lists/* 2>/dev/null || true
          
          # 4. æ¸…ç†pipç¼“å­˜
          echo "æ¸…ç†pipç¼“å­˜..."
          pip3 cache purge 2>/dev/null || true
          
          # 5. æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          echo "æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
          sudo rm -rf /tmp/* 2>/dev/null || true
          sudo rm -rf /var/tmp/* 2>/dev/null || true
          
          # 6. æ¸…ç†ä¸‹è½½çš„å‹ç¼©åŒ…
          rm -f sdk.tar.xz 2>/dev/null || true
          
          # 7. æ¸…ç†release-artifactsä»¥å¤–çš„ç›®å½•
          echo "ä¿ç•™release-artifactsç›®å½•ï¼Œæ¸…ç†å…¶ä»–..."
          if [ -d "release-artifacts" ]; then
            # åˆ›å»ºä¸´æ—¶ç›®å½•ä¿å­˜releaseæ–‡ä»¶
            mkdir -p /tmp/release-backup
            cp -r release-artifacts/* /tmp/release-backup/ 2>/dev/null || true
            
            # æ¸…ç†å½“å‰ç›®å½•
            find . -maxdepth 1 ! -name "release-artifacts" ! -name "." -exec rm -rf {} + 2>/dev/null || true
            
            # æ¢å¤releaseæ–‡ä»¶
            mv /tmp/release-backup/* release-artifacts/ 2>/dev/null || true
            rm -rf /tmp/release-backup
          fi
          
          # 8. è®¡ç®—æ¸…ç†åç£ç›˜ä½¿ç”¨æƒ…å†µ
          echo "æ¸…ç†åç£ç›˜ä½¿ç”¨æƒ…å†µ:"
          df -h
          echo "æ¸…ç†åå·¥ä½œç©ºé—´å¤§å°:"
          du -sh . 2>/dev/null || true
          
          echo "âœ… å·¥ä½œç©ºé—´æ¸…ç†å®Œæˆ"

      - name: 14. ä¸Šä¼ æœ€ç»ˆäº§ç‰©ï¼ˆæ¸…ç†åï¼‰
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: æœ€ç»ˆäº§ç‰©-${{ github.run_id }}
          path: |
            release-artifacts/
          retention-days: 7

      - name: 15. ç”Ÿæˆæ„å»ºæŠ¥å‘Š
        if: always()
        run: |
          echo "========================================"
          echo "æ„å»ºçŠ¶æ€æŠ¥å‘Š - X86_64ç‰ˆæœ¬"
          echo "========================================"
          echo "ä½œä¸šçŠ¶æ€: ${{ job.status }}"
          echo "è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          echo "å·¥ä½œæµID: ${{ github.run_id }}"
          echo "è¿è¡Œç¼–å·: ${{ github.run_number }}"
          
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "ç‰ˆæœ¬å·: ${{ github.event.inputs.version }}"
            echo "é¢„å‘å¸ƒç‰ˆæœ¬: ${{ github.event.inputs.prerelease }}"
          elif [ "${{ github.event_name }}" = "push" ]; then
            echo "æ ‡ç­¾: ${{ github.ref_name }}"
            echo "æäº¤SHA: ${{ github.sha }}"
          fi
          
          echo ""
          echo "ğŸ“Š ç£ç›˜ä½¿ç”¨æƒ…å†µ:"
          df -h | grep -E "Filesystem|/dev/"
          
          echo ""
          if [ -d release-artifacts ]; then
            echo "ğŸ“¦ å‘å¸ƒæ–‡ä»¶åˆ—è¡¨:"
            ls -lh release-artifacts/
            
            echo ""
            echo "ğŸ”§ æ’ä»¶ä¿¡æ¯:"
            if [ -f release-artifacts/README.md ]; then
              grep -E "æ–‡ä»¶å|ç‰ˆæœ¬|æ¶æ„|å¤§å°" release-artifacts/README.md | head -4
            fi
          else
            echo "âŒ å‘å¸ƒç›®å½•ä¸å­˜åœ¨"
          fi
          
          echo ""
          echo "========================================"
          echo "æ„å»ºå®Œæˆ"
          echo "========================================"
