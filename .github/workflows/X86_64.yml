name: Build luci-app-openvpn-admin (X86_64)
on: [workflow_dispatch]

jobs:
  build-x86:
    runs-on: ubuntu-22.04
    timeout-minutes: 180
    env:
      MAKE_JOBS: 4  # x86ç¼–è¯‘å¯ä»¥ä½¿ç”¨æ›´å¤šçº¿ç¨‹
      # ä¿®æ”¹ä¸ºx86_64æ¶æ„çš„SDK
      SDK_URL: "https://downloads.immortalwrt.org/releases/23.05.0/targets/x86/64/immortalwrt-sdk-23.05.0-x86-64_gcc-12.3.0_musl.Linux-x86_64.tar.xz"
      # x86çš„ä¾èµ–åŒ…
      DEPENDENCIES: "openssl-util curl openvpn-openssl luci-lib-jsonc luci-compat luci-base"

    steps:
      - name: 1. Checkout code
        uses: actions/checkout@v4

      - name: 2. Install build dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y build-essential libncurses5-dev gawk git wget unzip python3 python3-pip file rsync curl python3-pyelftools subversion time
          sudo pip3 install pyelftools || true

      - name: 3. Download & extract ImmortalWrt SDK
        id: sdk
        run: |
          wget --timeout=60 --tries=3 $SDK_URL -O sdk.tar.xz || { echo "SDK download failed"; exit 1; }
          tar xf sdk.tar.xz && mv $(find . -maxdepth 1 -type d -name "*sdk*" | head -1) openwrt-sdk
          ls -la openwrt-sdk/

      - name: 4. Prepare package files
        run: |
          cd openwrt-sdk
          # æ¸…ç†æ—§ç›®å½•ï¼Œåˆ›å»ºæ–°ç›®å½•
          rm -rf package/luci-app-openvpn-admin && mkdir -p package/luci-app-openvpn-admin
          # å¤åˆ¶ä¿®æ­£åçš„ Makefile
          [ -f ../Makefile ] && cp ../Makefile package/luci-app-openvpn-admin/
          # å¤åˆ¶ luasrc/root ç›®å½•ï¼ˆæ–°ç»“æ„ï¼‰ï¼Œè€Œé files ç›®å½•
          [ -d ../luasrc ] && cp -r ../luasrc package/luci-app-openvpn-admin/
          [ -d ../root ] && cp -r ../root package/luci-app-openvpn-admin/
          # å…¼å®¹æ—§ files ç›®å½•
          if [ -d ../files ]; then
            mkdir -p package/luci-app-openvpn-admin/root
            cp -r ../files/* package/luci-app-openvpn-admin/root/
          fi
          # éªŒè¯ç›®å½•ç»“æ„
          echo "==== Package dir structure ===="
          find package/luci-app-openvpn-admin -type d | sort | head -20

      - name: 5. Update feeds & install dependencies
        run: |
          cd openwrt-sdk
          ./scripts/feeds update -a -f
          # å®‰è£…å¿…è¦çš„ä¾èµ–
          ./scripts/feeds install luci-base luci-lib-jsonc luci-compat openvpn-openssl curl openssl-util || true
          # æ£€æŸ¥ä¾èµ–æ˜¯å¦å®‰è£…æˆåŠŸ
          echo "==== Installed feeds ===="
          ./scripts/feeds list | grep -E "luci|openvpn|curl"

      - name: 6. Generate .config (é…ç½®ä¸ºx86_64æ¶æ„)
        run: |
          cd openwrt-sdk
          cat > .config << EOF
          CONFIG_TARGET_x86=y
          CONFIG_TARGET_x86_64=y
          CONFIG_TARGET_x86_64_DEVICE_generic=y
          CONFIG_PACKAGE_luci-app-openvpn-admin=y
          EOF
          make defconfig
          echo "==== é…ç½®æ‘˜è¦ ===="
          grep -E "CONFIG_TARGET|CONFIG_PACKAGE|CONFIG_OPENVPN" .config

      - name: 7. Compile dependencies
        run: |
          cd openwrt-sdk
          for pkg in $DEPENDENCIES; do
            echo "==== Compiling $pkg ===="
            pkg_path=$(find package feeds -name $pkg -type d | head -1)
            if [ -n "$pkg_path" ]; then
              make package/$pkg/compile V=sc -j$MAKE_JOBS || echo "âš  $pkg compile failed, skip (non-critical)"
            else
              echo "âš  $pkg not found in feeds, skip"
            fi
          done

      - name: 8. Compile main package
        run: |
          cd openwrt-sdk
          [ ! -d "package/luci-app-openvpn-admin" ] && { echo "Package dir missing"; exit 1; }
          # æ¸…ç†æ—§æ„å»ºæ–‡ä»¶
          make package/luci-app-openvpn-admin/clean
          # ç¼–è¯‘å¹¶è¾“å‡ºè¯¦ç»†æ—¥å¿—
          make package/luci-app-openvpn-admin/compile V=s -j$MAKE_JOBS 2>&1 | tee compile-log.txt
          # æ£€æŸ¥ç¼–è¯‘ç»“æœ
          MAIN_IPK=$(find bin -name "*luci-app-openvpn-admin*.ipk" -type f | head -1)
          if [ -z "$MAIN_IPK" ]; then
            echo "==== Compile log (last 100 lines) ===="
            tail -100 compile-log.txt
            echo "âŒ Main package compile failed"
          else
            echo "âœ… Main package compiled: $MAIN_IPK"
          fi

      - name: 8.5 Debug - æŸ¥æ‰¾æ‰€æœ‰ç¼–è¯‘è¾“å‡º
        run: |
          cd openwrt-sdk
          echo "==== æœç´¢æ‰€æœ‰IPKæ–‡ä»¶ ===="
          find . -name "*.ipk" -type f 2>/dev/null | sort
          
          echo "==== æŸ¥çœ‹binç›®å½•ç»“æ„ ===="
          find bin -type f 2>/dev/null | head -30
          
          echo "==== æŸ¥çœ‹packagesç›®å½• ===="
          find bin/packages -name "*.ipk" 2>/dev/null | grep -i openvpn
          
          echo "==== æ£€æŸ¥ç¼–è¯‘æ—¥å¿—ä¸­çš„é”™è¯¯ ===="
          if [ -f compile-log.txt ]; then
            grep -i "error\|failed\|cannot\|undefined" compile-log.txt | head -20
          fi

      - name: 8.6 Debug - æ£€æŸ¥æ’ä»¶ç›®å½•çŠ¶æ€
        run: |
          cd openwrt-sdk/package/luci-app-openvpn-admin
          echo "==== æ’ä»¶ç›®å½•å†…å®¹ ===="
          ls -la
          echo "==== Makefileå†…å®¹ ===="
          cat Makefile 2>/dev/null || echo "Makefile not found"
          echo "==== ç›®å½•ç»“æ„ ===="
          find . -type d | sort

      - name: 9. Collect artifacts (å¢å¼ºç‰ˆ)
        run: |
          cd openwrt-sdk
          
          # 1. æ‰¾åˆ°æ‰€æœ‰IPKæ–‡ä»¶ï¼Œæ— è®ºä½ç½®
          echo "==== æŸ¥æ‰¾æ‰€æœ‰IPKæ–‡ä»¶ ===="
          find . -name "*.ipk" -type f 2>/dev/null > all_ipks.txt
          echo "æ‰¾åˆ°çš„IPKæ–‡ä»¶:"
          cat all_ipks.txt
          
          # 2. åˆ›å»ºè¾“å‡ºç›®å½•
          mkdir -p ../output-x86_64
          
          # 3. å¤åˆ¶æ‰€æœ‰IPKåˆ°è¾“å‡ºç›®å½•
          while IFS= read -r ipk_path; do
            if [ -f "$ipk_path" ]; then
              filename=$(basename "$ipk_path")
              echo "å¤åˆ¶: $filename"
              cp "$ipk_path" ../output-x86_64/
            fi
          done < all_ipks.txt
          
          # 4. åˆ—å‡ºè¾“å‡ºç›®å½•
          echo "==== è¾“å‡ºç›®å½•å†…å®¹ ===="
          ls -lh ../output-x86_64/
          
          # 5. æŒ‰å¤§å°æ’åº
          echo "==== æŒ‰æ–‡ä»¶å¤§å°æ’åº ===="
          ls -lhS ../output-x86_64/ | head -10
          
          # 6. éªŒè¯æ˜¯å¦æ‰¾åˆ°ä¸»æ’ä»¶
          MAIN_IPK=$(find ../output-x86_64 -name "*luci-app-openvpn-admin*.ipk" 2>/dev/null | head -1)
          if [ -z "$MAIN_IPK" ]; then
            echo "è­¦å‘Šï¼šæœªæ‰¾åˆ°ä¸»æ’ä»¶IPKï¼Œå°è¯•å…¶ä»–æ¨¡å¼..."
            # å°è¯•æŸ¥æ‰¾ä»»ä½•åŒ…å«openvpnçš„IPK
            find ../output-x86_64 -name "*openvpn*.ipk" 2>/dev/null
            # æ£€æŸ¥Makefileä¸­çš„åŒ…å
            if [ -f package/luci-app-openvpn-admin/Makefile ]; then
              echo "==== Makefileä¸­çš„åŒ…åå®šä¹‰ ===="
              grep -i "PKG_NAME\|PKG_TITLE" package/luci-app-openvpn-admin/Makefile
            fi
          else
            echo "âœ… æ‰¾åˆ°ä¸»æ’ä»¶: $(basename $MAIN_IPK)"
            # æŸ¥çœ‹IPKå†…å®¹
            echo "IPKå†…å®¹ç»“æ„:"
            tar -tzf $MAIN_IPK | head -20
          fi

      - name: 10. Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: openvpn-admin-x86_64
          path: output-x86_64/
          retention-days: 7

      - name: 11. Build report
        if: always()
        run: |
          echo "========================================"
          echo "æ„å»ºçŠ¶æ€æŠ¥å‘Š - X86_64"
          echo "========================================"
          echo "æ¶æ„ï¼šx86_64 (64ä½)"
          echo "å›ºä»¶ç‰ˆæœ¬ï¼šImmortalWrt 23.05.0"
          echo "ä½œä¸šçŠ¶æ€: ${{ job.status }}"
          echo "SDKä¸‹è½½çŠ¶æ€: ${{ steps.sdk.outcome }}"
          echo ""
          if [ -d output-x86_64 ]; then
            IPK_COUNT=$(find output-x86_64 -name "*.ipk" 2>/dev/null | wc -l)
            echo "ğŸ“¦ ç”Ÿæˆçš„IPKæ•°é‡: $IPK_COUNT"
            echo "ğŸ“‹ IPKåˆ—è¡¨:"
            ls -lh output-x86_64/
            MAIN_IPK=$(find output-x86_64 -name "*luci-app-openvpn-admin*.ipk" 2>/dev/null | head -1)
            if [ -n "$MAIN_IPK" ]; then
              echo "âœ… æ ¸å¿ƒæ’ä»¶: $(basename $MAIN_IPK)"
              echo "ğŸ“Š æ–‡ä»¶å¤§å°: $(du -h $MAIN_IPK | cut -f1)"
              echo "ğŸ” æ¶æ„ä¿¡æ¯:"
              # æå–IPKä¸­çš„æ§åˆ¶ä¿¡æ¯
              tar -xzOf $MAIN_IPK ./control.tar.gz 2>/dev/null | tar -xzO ./control 2>/dev/null | grep -E "Architecture|Version|Package" || echo "æ— æ³•æå–æ§åˆ¶ä¿¡æ¯"
            else
              echo "âŒ æ ¸å¿ƒæ’ä»¶ç¼–è¯‘å¤±è´¥"
              echo "å°è¯•æŸ¥æ‰¾å…¶ä»–openvpnç›¸å…³åŒ…:"
              find output-x86_64 -name "*openvpn*.ipk" 2>/dev/null || echo "æœªæ‰¾åˆ°"
            fi
          else
            echo "âŒ è¾“å‡ºç›®å½•ä¸å­˜åœ¨"
          fi
