# OpenWrt/LEDE/ImmortalWrt åŒ…æ„å»º Makefile
# è¿™æ˜¯ OpenWrt SDK ä½¿ç”¨çš„æ ‡å‡†åŒ… Makefile

include $(TOPDIR)/rules.mk

# åŒ…ä¿¡æ¯
PKG_NAME:=luci-app-openvpn-admin
PKG_VERSION:=1.0.0
PKG_RELEASE:=1

# æ„å»ºç›®å½•
PKG_BUILD_DIR:=$(BUILD_DIR)/$(PKG_NAME)-$(PKG_VERSION)

# åŒ…å« OpenWrt åŒ…å®šä¹‰
include $(INCLUDE_DIR)/package.mk

# LuCI åŒ…å®šä¹‰
include $(INCLUDE_DIR)/luci.mk

# åŒ…å®šä¹‰
define Package/$(PKG_NAME)
  SECTION:=luci
  CATEGORY:=LuCI
  SUBMENU:=3. Applications
  TITLE:=OpenVPN Management Interface
  PKGARCH:=all
  DEPENDS:= \
    +luci-base \
    +openvpn-openssl \
    +luci-lib-jsonc \
    +easy-rsa \
    +curl \
    +openssl-util \
    +netcat-openbsd \
    +bash
endef

# åŒ…æè¿°
define Package/$(PKG_NAME)/description
  ä¸€ä¸ªåŠŸèƒ½å®Œæ•´çš„ OpenVPN ç®¡ç†ç•Œé¢ï¼ŒåŒ…å«çŠ¶æ€ç›‘æ§ã€å®¢æˆ·ç«¯ç®¡ç†ã€æœåŠ¡ç«¯é…ç½®ã€æ—¥å¿—æŸ¥çœ‹å’Œè®¾ç½®åŠŸèƒ½ã€‚
  æ”¯æŒåŸºäºCNçš„é»‘åå•ç®¡ç†ã€å®¢æˆ·ç«¯è¯ä¹¦ç”Ÿæˆã€å®æ—¶è¿æ¥ç›‘æ§ç­‰ã€‚
  
  A comprehensive OpenVPN management interface for OpenWrt/LEDE/ImmortalWrt.
  Features include client management, certificate generation, connection monitoring,
  and server configuration.
  
  ä¸»è¦åŠŸèƒ½:
  - å®æ—¶ OpenVPN è¿æ¥çŠ¶æ€ç›‘æ§
  - å®¢æˆ·ç«¯é…ç½®ç”Ÿæˆå’Œè¯ä¹¦ç®¡ç†
  - æœåŠ¡ç«¯é…ç½®ç®¡ç†
  - æ—¥å¿—æŸ¥çœ‹å’Œè¿‡æ»¤
  - å®¢æˆ·ç«¯é»‘åå•ç®¡ç†
  - å¤šè¯­è¨€æ”¯æŒ (ä¸­æ–‡/è‹±æ–‡)
endef

# æ„å»ºå‡†å¤‡é˜¶æ®µ
define Build/Prepare
	# åˆ›å»ºæ„å»ºç›®å½•
	mkdir -p $(PKG_BUILD_DIR)
endef

# é…ç½®é˜¶æ®µ
define Build/Configure
endef

# ç¼–è¯‘é˜¶æ®µ
define Build/Compile
endef

# å®‰è£…é˜¶æ®µ - è¿™æ˜¯æœ€é‡è¦çš„éƒ¨åˆ†ï¼Œå®šä¹‰æ–‡ä»¶å¦‚ä½•å®‰è£…åˆ°è·¯ç”±å™¨
define Package/$(PKG_NAME)/install
	# åˆ›å»ºåŸºæœ¬ç›®å½•ç»“æ„
	$(INSTALL_DIR) $(1)/usr/lib/lua/luci
	$(INSTALL_DIR) $(1)/etc/config
	$(INSTALL_DIR) $(1)/etc/openvpn-admin
	$(INSTALL_DIR) $(1)/tmp/openvpn-admin
	$(INSTALL_DIR) $(1)/etc/openvpn-admin/template
	
	# å®‰è£… LuCI æ§åˆ¶å™¨
	$(INSTALL_DIR) $(1)/usr/lib/lua/luci/controller
	$(INSTALL_DATA) ./files/usr/lib/lua/luci/controller/openvpn-admin.lua \
		$(1)/usr/lib/lua/luci/controller/openvpn-admin.lua
	
	# å®‰è£… LuCI è§†å›¾æ–‡ä»¶
	$(INSTALL_DIR) $(1)/usr/lib/lua/luci/view/openvpn-admin
	$(INSTALL_DATA) ./files/usr/lib/lua/luci/view/openvpn-admin/client.htm \
		$(1)/usr/lib/lua/luci/view/openvpn-admin/client.htm
	$(INSTALL_DATA) ./files/usr/lib/lua/luci/view/openvpn-admin/server.htm \
		$(1)/usr/lib/lua/luci/view/openvpn-admin/server.htm
	$(INSTALL_DATA) ./files/usr/lib/lua/luci/view/openvpn-admin/status.htm \
		$(1)/usr/lib/lua/luci/view/openvpn-admin/status.htm
	$(INSTALL_DATA) ./files/usr/lib/lua/luci/view/openvpn-admin/logs.htm \
		$(1)/usr/lib/lua/luci/view/openvpn-admin/logs.htm
	$(INSTALL_DATA) ./files/usr/lib/lua/luci/view/openvpn-admin/settings.htm \
		$(1)/usr/lib/lua/luci/view/openvpn-admin/settings.htm
	
	# å®‰è£… UCI é…ç½®æ–‡ä»¶
	$(INSTALL_DATA) ./files/etc/config/openvpn-admin \
		$(1)/etc/config/openvpn-admin
	
	# å®‰è£…è„šæœ¬æ–‡ä»¶ï¼ˆè®¾ç½®æ‰§è¡Œæƒé™ï¼‰
	$(INSTALL_BIN) ./files/etc/openvpn-admin/generate-client.sh \
		$(1)/etc/openvpn-admin/generate-client.sh
	$(INSTALL_BIN) ./files/etc/openvpn-admin/client-connect-cn.sh \
		$(1)/etc/openvpn-admin/client-connect-cn.sh
	$(INSTALL_BIN) ./files/etc/openvpn-admin/clean-garbage.sh \
		$(1)/etc/openvpn-admin/clean-garbage.sh
	$(INSTALL_BIN) ./files/etc/openvpn-admin/renewcert.sh \
		$(1)/etc/openvpn-admin/renewcert.sh
	
	# å®‰è£…æ¨¡æ¿æ–‡ä»¶
	$(INSTALL_DATA) ./files/etc/openvpn-admin/template/server.template \
		$(1)/etc/openvpn-admin/template/server.template
	
	# åˆ›å»ºç©ºçš„é…ç½®æ–‡ä»¶ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
	$(INSTALL_DIR) $(1)/etc/openvpn
	$(INSTALL_DIR) $(1)/etc/openvpn/pki
	
	# åˆ›å»ºè¿è¡Œæ—¶ç›®å½•
	$(INSTALL_DIR) $(1)/tmp/openvpn-admin
	$(INSTALL_DIR) $(1)/var/log
	
	# è®¾ç½®ç›®å½•æƒé™
	$(SED) 's/^\([[:space:]]*\)$(INSTALL_DIR)/\1$(INSTALL_DIR)/' $(1)/tmp/openvpn-admin
endef

# åå®‰è£…è„šæœ¬ - å®‰è£…åæ‰§è¡Œ
define Package/$(PKG_NAME)/postinst
#!/bin/sh
# åªåœ¨çœŸå®ç³»ç»Ÿä¸Šæ‰§è¡Œï¼Œä¸åœ¨æ„å»ºç¯å¢ƒä¸­æ‰§è¡Œ
if [ -z "$${IPKG_INSTROOT}" ]; then
	# åˆ›å»ºå¿…è¦çš„ç›®å½•
	echo "åˆ›å»ºå¿…è¦çš„ç›®å½•..."
	mkdir -p /etc/openvpn-admin/template 2>/dev/null
	mkdir -p /tmp/openvpn-admin 2>/dev/null
	mkdir -p /etc/openvpn/pki 2>/dev/null
	mkdir -p /etc/openvpn-admin 2>/dev/null
	
	# è®¾ç½®è„šæœ¬æ‰§è¡Œæƒé™
	echo "è®¾ç½®è„šæœ¬æ‰§è¡Œæƒé™..."
	chmod 755 /etc/openvpn-admin/*.sh 2>/dev/null || true
	chmod 755 /tmp/openvpn-admin 2>/dev/null || true
	
	# åˆå§‹åŒ– UCI é…ç½®ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
	if ! uci -q get openvpn-admin.@settings[0] >/dev/null 2>&1; then
		echo "åˆå§‹åŒ– OpenVPN Admin é…ç½®..."
		
		# åˆ›å»ºé»˜è®¤é…ç½®
		uci batch << EOF
set openvpn-admin.settings=settings
set openvpn-admin.settings.openvpn_instance='myvpn'
set openvpn-admin.settings.openvpn_config_path='/etc/config/openvpn'
set openvpn-admin.settings.refresh_enabled='1'
set openvpn-admin.settings.refresh_interval='1'
set openvpn-admin.settings.history_size='20'
set openvpn-admin.settings.blacklist_enabled='1'
set openvpn-admin.settings.blacklist_duration='300'
set openvpn-admin.settings.log_file='/tmp/openvpn.log'
set openvpn-admin.settings.history_file='/etc/openvpn-admin/openvpn_connection_history.json'
set openvpn-admin.settings.blacklist_file='/etc/openvpn-admin/blacklist.json'
set openvpn-admin.settings.easyrsa_dir='/etc/easy-rsa'
set openvpn-admin.settings.easyrsa_pki='/etc/easy-rsa/pki'
set openvpn-admin.settings.openvpn_pki='/etc/openvpn/pki'
set openvpn-admin.settings.logs_refresh_enabled='1'
set openvpn-admin.settings.logs_refresh_interval='10'
set openvpn-admin.settings.logs_display_lines='1000'
set openvpn-admin.settings.generate_client_script='/etc/openvpn-admin/generate-client.sh'
set openvpn-admin.settings.renew_cert_script='/etc/openvpn-admin/renewcert.sh'
set openvpn-admin.settings.temp_dir='/tmp/openvpn-admin'
set openvpn-admin.settings.clean_garbage_enabled='0'
set openvpn-admin.settings.clean_garbage_time='4:50'
set openvpn-admin.settings.clean_garbage_script='/etc/openvpn-admin/clean-garbage.sh'
set openvpn-admin.settings.server_template_path='/etc/openvpn-admin/template/server.template'
commit openvpn-admin
EOF
		
		echo "âœ… é»˜è®¤é…ç½®å·²åˆ›å»º"
	fi
	
	# æ£€æŸ¥å¹¶åˆ›å»ºå¿…è¦çš„ç³»ç»Ÿç›®å½•
	if [ ! -d "/etc/easy-rsa" ]; then
		echo "âš ï¸  è­¦å‘Š: /etc/easy-rsa ç›®å½•ä¸å­˜åœ¨ï¼ŒEasyRSA å¯èƒ½æœªå®‰è£…"
		echo "è¯·å®‰è£… easy-rsa åŒ…: opkg install easy-rsa"
	fi
	
	if [ ! -f "/etc/openvpn-addon.conf" ]; then
		echo "åˆ›å»º OpenVPN é™„åŠ é…ç½®æ–‡ä»¶..."
		touch /etc/openvpn-addon.conf
	fi
	
	# é‡æ–°åŠ è½½æœåŠ¡
	echo "é‡æ–°åŠ è½½æœåŠ¡..."
	/etc/init.d/uhttpd reload >/dev/null 2>&1 || true
	/etc/init.d/rpcd reload >/dev/null 2>&1 || true
	/etc/init.d/cron reload >/dev/null 2>&1 || true
	
	echo ""
	echo "=========================================="
	echo "âœ… OpenVPN Admin æ’ä»¶å®‰è£…å®Œæˆ!"
	echo "=========================================="
	echo ""
	echo "ğŸŒ è®¿é—®åœ°å€:"
	echo "  1. æ‰“å¼€æµè§ˆå™¨è®¿é—®è·¯ç”±å™¨ç®¡ç†ç•Œé¢"
	echo "  2. è¿›å…¥ 'VPN' -> 'OpenVPN ç®¡ç†'"
	echo ""
	echo "ğŸ“‹ åŠŸèƒ½èœå•:"
	echo "  - çŠ¶æ€: æŸ¥çœ‹ OpenVPN è¿æ¥çŠ¶æ€"
	echo "  - å®¢æˆ·ç«¯: ç”Ÿæˆå®¢æˆ·ç«¯é…ç½®å’Œè¯ä¹¦"
	echo "  - æœåŠ¡ç«¯: é…ç½® OpenVPN æœåŠ¡å™¨"
	echo "  - æ—¥å¿—: æŸ¥çœ‹ OpenVPN æ—¥å¿—"
	echo "  - è®¾ç½®: é…ç½®æ’ä»¶é€‰é¡¹"
	echo ""
	echo "ğŸ”§ éœ€è¦å®‰è£…çš„ä¾èµ–åŒ…:"
	echo "  - openvpn-openssl (OpenVPN æœåŠ¡)"
	echo "  - easy-rsa (è¯ä¹¦ç®¡ç†)"
	echo "  - luci-lib-jsonc (JSON æ”¯æŒ)"
	echo ""
	echo "ğŸ“ é¦–æ¬¡ä½¿ç”¨å»ºè®®:"
	echo "  1. åœ¨'è®¾ç½®'é¡µé¢æ£€æŸ¥é…ç½®"
	echo "  2. åœ¨'å®¢æˆ·ç«¯'é¡µé¢ç”Ÿæˆç¬¬ä¸€ä¸ªå®¢æˆ·ç«¯é…ç½®"
	echo "  3. åœ¨'çŠ¶æ€'é¡µé¢æŸ¥çœ‹è¿æ¥æƒ…å†µ"
	echo "=========================================="
fi

exit 0
endef

# é¢„åˆ é™¤è„šæœ¬ - åˆ é™¤å‰æ‰§è¡Œ
define Package/$(PKG_NAME)/prerm
#!/bin/sh
# åªåœ¨çœŸå®ç³»ç»Ÿä¸Šæ‰§è¡Œï¼Œä¸åœ¨æ„å»ºç¯å¢ƒä¸­æ‰§è¡Œ
if [ -z "$${IPKG_INSTROOT}" ]; then
	echo "å‡†å¤‡å¸è½½ OpenVPN Admin æ’ä»¶..."
	
	# åœæ­¢å¯èƒ½ç›¸å…³çš„æœåŠ¡
	echo "åœæ­¢ç›¸å…³æœåŠ¡..."
	/etc/init.d/uhttpd reload >/dev/null 2>&1 || true
	
	# æ¸…ç† cron ä»»åŠ¡
	echo "æ¸…ç†å®šæ—¶ä»»åŠ¡..."
	if [ -f "/etc/crontabs/root" ]; then
		sed -i '/# OpenVPNç®¡ç†æ’ä»¶åƒåœ¾æ¸…ç†ä»»åŠ¡/d' /etc/crontabs/root
		sed -i '/clean-garbage.sh/d' /etc/crontabs/root
		/etc/init.d/cron reload >/dev/null 2>&1 || true
	fi
	
	# å¤‡ä»½é…ç½®æ–‡ä»¶
	echo "å¤‡ä»½é…ç½®æ–‡ä»¶..."
	if [ -f "/etc/config/openvpn-admin" ]; then
		cp /etc/config/openvpn-admin /tmp/openvpn-admin-backup-$(date +%Y%m%d%H%M%S).conf
		echo "é…ç½®æ–‡ä»¶å·²å¤‡ä»½åˆ° /tmp/"
	fi
	
	echo "âœ… å¸è½½å‡†å¤‡å®Œæˆ"
fi

exit 0
endef

# ååˆ é™¤è„šæœ¬ - åˆ é™¤åæ‰§è¡Œ
define Package/$(PKG_NAME)/postrm
#!/bin/sh
# åªåœ¨çœŸå®ç³»ç»Ÿä¸Šæ‰§è¡Œï¼Œä¸åœ¨æ„å»ºç¯å¢ƒä¸­æ‰§è¡Œ
if [ -z "$${IPKG_INSTROOT}" ]; then
	echo "æ¸…ç†æ®‹ç•™æ–‡ä»¶..."
	
	# åˆ é™¤ä¸´æ—¶ç›®å½•ï¼ˆä½†ä¿ç•™ç”¨æˆ·æ•°æ®ï¼‰
	if [ -d "/tmp/openvpn-admin" ]; then
		echo "æ¸…ç†ä¸´æ—¶ç›®å½•..."
		rm -rf /tmp/openvpn-admin/* 2>/dev/null || true
	fi
	
	# é‡æ–°åŠ è½½ LuCI
	echo "é‡æ–°åŠ è½½ LuCI..."
	/etc/init.d/uhttpd restart >/dev/null 2>&1 || true
	
	echo "âœ… OpenVPN Admin æ’ä»¶å·²å®Œå…¨ç§»é™¤"
	echo ""
	echo "ğŸ“ æ³¨æ„:"
	echo "  - é…ç½®æ–‡ä»¶å·²å¤‡ä»½åˆ° /tmp/openvpn-admin-backup-*.conf"
	echo "  - ç”¨æˆ·æ•°æ®æ–‡ä»¶ä»ä¿ç•™åœ¨ /etc/openvpn-admin/"
	echo "  - å¦‚éœ€å®Œå…¨æ¸…ç†ï¼Œè¯·æ‰‹åŠ¨åˆ é™¤ç›¸å…³ç›®å½•"
fi

exit 0
endef

# å®šä¹‰åŒ…æ„å»º
$(eval $(call BuildPackage,$(PKG_NAME)))

# æ„å»ºä¿¡æ¯æ˜¾ç¤º
define Build/ShowInfo
	@echo "=========================================="
	@echo "OpenVPN Admin æ’ä»¶æ„å»ºä¿¡æ¯"
	@echo "=========================================="
	@echo "åŒ…åç§°:    $(PKG_NAME)"
	@echo "ç‰ˆæœ¬:      $(PKG_VERSION)-$(PKG_RELEASE)"
	@echo "æ¶æ„:      $(PKGARCH)"
	@echo "æ„å»ºç›®å½•:  $(PKG_BUILD_DIR)"
	@echo "ä¾èµ–åŒ…:    $(DEPENDS)"
	@echo ""
	@echo "åŒ…å«æ–‡ä»¶:"
	@echo "  - LuCI æ§åˆ¶å™¨: openvpn-admin.lua"
	@echo "  - è§†å›¾æ–‡ä»¶: client.htm, server.htm, status.htm, logs.htm, settings.htm"
	@echo "  - é…ç½®æ–‡ä»¶: openvpn-admin"
	@echo "  - è„šæœ¬æ–‡ä»¶: generate-client.sh, client-connect-cn.sh, renewcert.sh, clean-garbage.sh"
	@echo "  - æ¨¡æ¿æ–‡ä»¶: server.template"
	@echo "=========================================="
endef

# åœ¨ç¼–è¯‘åæ˜¾ç¤ºä¿¡æ¯
Build/Compile: Build/ShowInfo
